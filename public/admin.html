<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="tab-icon.png" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Fredoka+One&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
      /* Upload Template Modal styles (copied to match finalprof) */
      #upload-template-modal {position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items:center; justify-content:center; z-index: 11000;}
      #upload-template-modal.active {display:flex;}
      .upload-template-modal {background:#fff;border-radius:14px; width: 860px; max-width:95vw; max-height:90vh; padding:0; box-sizing:border-box; display:flex; font-family:'Poppins',sans-serif; color:#333; position:relative; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.3);} 
      .upload-close-btn {position:absolute; top:12px; right:16px; background:transparent; border:none; font-size:26px; font-weight:700; color:#d72b7e; cursor:pointer;}
      .upload-close-btn:hover {color:#a4154f;}
      .upload-preview-side {width:180px; background:#f9d7e7; padding:20px; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:width .3s ease;}
      .upload-preview-side.is-4x6 { width:380px; }
      .preview-title {font-weight:700; font-size:16px; color:#d72b7e; margin-bottom:16px;}
      .preview-image { width:140px; height:400px; border-radius:10px; border:4px solid #fff; background:#f5f5f5; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; transition: width .3s ease, height .3s ease; }
      .preview-image.size-2x6 { width:140px; height:400px; }
      .preview-image.size-4x6 { width:340px; height:510px; max-height:80vh; }
      .preview-image img {width:100%; height:100%; object-fit:cover; border-radius:6px;}
      .preview-placeholder { color:#d72b7e; font-size:12px; text-align:center; padding:20px; }
      .upload-controls-side { flex-grow:1; display:flex; flex-direction:column; padding:20px 24px; box-sizing:border-box; overflow-y:auto; max-height:600px; gap:16px; }
      .section-heading {font-weight:600; font-size:16px; color:#333; margin-bottom:8px;}
      .layout-section {display:flex; flex-direction:column; gap:12px;}
      .layout-options {display:flex; gap:20px; align-items:center;}
      .layout-option {display:flex; flex-direction:column; gap:8px;}
      .layout-option select {border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:14px; color:#333; background:#fff;}
      .upload-section {display:flex; flex-direction:column; gap:8px;}
      .upload-box {border:2px dashed #ddd; border-radius:8px; padding:20px 16px; text-align:center; cursor:pointer; transition:border-color .3s; background:#fafafa; min-height:60px; display:flex; flex-direction:column; justify-content:center; align-items:center;}
      .upload-box:hover {border-color:#d23481; background:#fff5f9;}
      .upload-box .upload-text {font-size:14px; color:#333; margin-bottom:4px; font-weight:500;}
      .effects-section {display:flex; flex-direction:column; gap:8px;}
      .effects-grid {display:grid; grid-template-columns:repeat(3,1fr); gap:8px;}
      .effect-option {padding:10px 12px; border:1px solid #ddd; border-radius:6px; text-align:center; font-size:13px; color:#666; cursor:pointer; transition: all .3s; background:#fff; font-weight:500;}
      .effect-option:hover {border-color:#d23481; color:#d23481;}
      .effect-option.selected {border-color:#d23481; background:#d23481; color:#fff;}
      .modal-divider {height:1px; background:#eee; margin:8px 0;}
      .share-section {display:flex; align-items:center; gap:12px; font-size:14px; color:#333; margin-bottom:0; font-weight:500;}
      .toggle-input {width:44px; height:22px; appearance:none; background:#ddd; border-radius:11px; position:relative; cursor:pointer; transition: background-color .3s;}
      .toggle-input:checked {background:#d23481;}
      .toggle-input::before {content:''; position:absolute; width:18px; height:18px; border-radius:50%; background:#fff; top:2px; left:2px; transition: transform .3s;}
      .toggle-input:checked::before {transform: translateX(22px);}
      .tags-section {display:flex; flex-direction:column; gap:8px;}
      .tags-input {border:1px solid #ddd; border-radius:6px; padding:12px; font-size:14px; color:#333;}
      .publish-section {display:flex; justify-content:flex-end; margin-top:8px;}
      #publishBtn {background:#d23481; border:none; border-radius:20px; padding:12px 36px; font-weight:600; color:#fff; cursor:pointer; font-size:14px;}
      #publishBtn:disabled {background:#ccc; cursor:not-allowed;}

      /* Template preview container helpers (from finalprof) */
      .photobooth-template-container { position:relative; width:100%; height:100%; display:flex; flex-direction:column; background-size:cover; background-position:center; padding:4px; box-sizing:border-box; }
      .photobooth-template-container.layout-grid-2x2 { display:grid; grid-template-columns:1fr 1fr; align-content:flex-start; gap:0.5rem; padding-bottom:0.5rem; }
      .photobooth-template-container.layout-2cols { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; align-content:center; padding-bottom:0.5rem; }
      .photobooth-template-container.layout-grid-3shots { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; align-content:flex-start; padding-bottom:0.5rem; }
      .photobooth-template-container.layout-grid-3shots .photo-strip-image:nth-child(3) { grid-column:1 / -1; }
      .photobooth-template-container.layout-single { display:grid; grid-template-columns:1fr 1fr; align-items:center; justify-content:center; padding:0.5rem; }
      .photobooth-template-container.layout-4x6.layout-single .photo-strip-image { grid-column:1 / -1; width:100%; }
      .photo-strip-image { width:100%; flex-shrink:0; margin-bottom:4px; position:relative; overflow:hidden; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center; }
      .photo-strip-image .photo-slot { width:100%; height:100%; }
      .sticker-overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:2; }
      .sticker { position:absolute; width:40px; height:40px; background-size:contain; background-repeat:no-repeat; background-position:center; cursor:grab; transition:transform 0.2s ease, box-shadow 0.2s ease; z-index:3; }
      .sticker.dragging { cursor:grabbing; box-shadow:0 4px 15px rgba(0,0,0,0.3); transform:scale(1.1); z-index:10; }
      .sticker-resize-handle { position:absolute; bottom:-6px; right:-6px; width:24px; height:24px; background-color:#f645b1; border-radius:50%; cursor:nwse-resize; border:2px solid #fff; box-shadow:0 0 5px rgba(0,0,0,0.3); z-index:10; }
      .template-footer { flex-shrink:0; margin-top:auto; text-align:center; color:#555; font-size:10px; padding-top:5px; align-self:flex-end; }
    body {font-family: 'Poppins', sans-serif;background-color: #ffe6f3;margin: 0; color: #d23481;}
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 80px; border-right: 2px solid #d23481; display: flex; flex-direction: column; align-items: center; padding: 1rem 0; gap: 2rem;background-color: #ffe6f3;border-radius: 0 16px 16px 0;}
    .logo {margin-bottom:1rem;}
    .logo img { width:36px; height:36px;}
    .left-buttons { display:flex; flex-direction:column; align-items:center; gap:3rem; width:100%;}
    .left-buttons button {background:none; border:none; color:#d23481; cursor:pointer; font-weight:600; font-size:0.85rem; display:flex; flex-direction: column; align-items:center; gap:0.3rem;padding: 0.2rem 0;transition: color 0.3s;}
    .left-buttons button:hover {color: #0e0107;}
    .left-buttons button.active {color: #ea5a9f;font-weight: 700;}
    .left-buttons button img { width:24px; height:24px;}
    .main-content { flex-grow:1; padding:1.5rem 2rem; display:flex; flex-direction:column;}
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;}
    .topbar h1 { font-family:'Fredoka One',cursive; font-size:40px; font-weight:900; color:#d23481; margin:0; letter-spacing:-1px;}
    .right-buttons { display:flex; align-items:center; gap:1rem; }
    .right-buttons button { display:flex; align-items:center; gap:0.5rem; font-weight:600; font-size:1rem; border-radius:12px; padding:0.5rem 1rem; cursor:pointer; border:2px solid #d23481; background-color:#fff; color:#d23481; transition:background-color 0.3s,color 0.3s;}
    .right-buttons button img { width:28px; height:28px;}
    .right-buttons button:hover, .admin-btn { background-color:#d23481; color:#fff; border:2px solid #d23481; }
    .subnav { display:flex; border-bottom:2px solid #d23481; margin-bottom:1.5rem; gap:2rem; font-size:0.93rem;}
    .subnav button { background:none; border:none; cursor:pointer; padding-bottom:0.5rem; color:#d23481; border-bottom:3px solid transparent;}
    .subnav button.active { border-bottom:3px solid #d23481; font-weight:700;}
    /* Usage Stats Panel */
    .stats {display:flex; gap:1.5rem; margin-bottom:2rem;}
    .stat-card { background:white; border:1.5px solid #f4c1d9; border-radius:12px; padding:1.5rem 2rem; flex:1;}
    .stat-card h3 { margin-top:0; font-weight:700; font-size:1.2rem; color:#d23481; margin-bottom:0.5rem;}
    .number { font-size:2.8rem; font-weight:900; margin:0.2rem 0 0.5rem; color:black;}
    .growth { color:#7fc97f; font-weight:600; font-size:0.9rem;}
    .growth i { margin-right:0.3rem;}
    .charts {display:flex; gap:1.5rem;}
    .chart-card { background:white; flex:1; border-radius:12px; padding:1rem 1.5rem; border:1.5px solid #f4c1d9;}
    .chart-card h3 { margin-top:0; color:#d23481; font-weight:700;}
    .chart-placeholder { height:120px; background:transparent; border:none; border-radius:8px; display:flex; justify-content:center; align-items:center; font-weight:600; color:#d23481; margin-top:0.8rem;}
    /* Template Management Panel */
    .template {display:flex; gap:1.5rem; margin-bottom:1rem; align-items:center;}
    .upload-btn { flex:0 0 300px; height:120px; border-radius:16px; border:none; color:#fff; font-size:1.5rem; font-weight:bold; cursor:pointer;background: linear-gradient(90deg, #fa49c5 0%, #ffe86b 100%);display:flex; flex-direction:column; justify-content:center; align-items:center;}
    .upload-btn:hover {background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%);}
    .template-search {flex:1; display:flex; flex-direction:column; gap:.7rem;}
    .template-search-row-top {display:flex; gap:1rem; margin-bottom:.3rem;}
    .template-search-row-top input[type="text"] { flex:1; padding:0.9rem 1rem; font-size:1.05em; border-radius:9px; border:1.7px solid #e10994; outline:none;}
    .template-search-row-bottom {display:flex; gap:1rem; align-items:center;}
    .template-search-row-bottom label { font-weight:bold; margin-right:0.3rem; color:#e10994; font-size:1.05em;}
    .template-search-row-bottom select {padding:0.6rem 1rem; border-radius:8px; border:1.7px solid #fa49c5; font-size:1em; outline:none;}
    .template-search-row-bottom input[type="date"] {padding:0.3rem 0.5rem; border-radius:8px; border:1.7px solid #fa49c5; font-size:1em; outline:none;}
    .template-table { width:100%; border-collapse:collapse; background:#fffafb; margin-top:1.3rem; border-radius:12px; overflow:hidden;}
    .template-table thead tr {background:#fde1f2;}
    .template-table th, .template-table td {padding:1rem; text-align:left; font-size:1.07em; border-bottom:2px solid #fcc2f2;}
    .template-table th { color:#e10994; font-weight:bold;}
    .template-table tbody tr {border-bottom:1px solid #fadcea;}
    .template-table tbody tr:last-child { border-bottom:none;}
    .template-table td { color:#d23481; }
    .template-table td .action-icon {margin-right:.8rem; cursor:pointer; opacity:0.90; vertical-align:middle; width:20px; height:20px; transition:opacity .2s;}
    .template-table td .action-icon:last-child {margin-right:0;}
    .template-table td .action-icon:hover { opacity:1;}
    
    /* Modal styles with scroll */
    .modal-overlay {position: fixed;top: 0; left: 0; right: 0; bottom: 0;background: rgba(128, 128, 128, 0.6);display: flex;justify-content: center;align-items: center;z-index: 1000;overflow-y: auto; padding: 1rem;  }
    .modal {background: #fff;padding: 2rem 2.5rem;border-radius: 12px;width: 520px;max-height: 90vh;overflow-y: auto;font-family: 'Poppins', sans-serif;box-shadow: 0 8px 25px rgba(210, 52, 129, 0.25);box-sizing: border-box;position: relative;}
    #uploadModal .modal {width: 750px;max-height: none;overflow-y: visible;padding: 1.8rem 2.5rem;}
    .modal h2 {font-family: 'Fredoka One', cursive;font-size: 28px;font-weight: 900;color: #ea3b91;margin: 0 0 1rem 0;}
    label {font-weight: 600;font-size: 0.93rem;color: #ea3b91;margin-bottom: 0.3rem;display: block;}
    input[type="text"],
    select {width: 100%;padding: 0.55rem 1rem;font-size: 1rem;border: 1.5px solid #f9c6dd;border-radius: 10px;outline: none;margin-bottom: 0.8rem;color: #d23481;}
    input[type="text"]::placeholder {color: #f9b6d4;font-weight: 500;}
    .upload-instruction {margin-bottom: 0.5rem;color: #d23481;font-weight: 600;}
    #editDualUploadContainer .upload-instruction {color: #8BC34A;}
    .upload-form-row {display: flex;gap: 1rem;margin-bottom: 0.8rem;}
    .upload-form-row .form-group {flex: 1;}
    .upload-form-row label {margin-bottom: 0.5rem;}
    .upload-form-row input, .upload-form-row select {width: 100%;}
    .dual-upload-group {display: flex;flex-direction: column;gap: 0.8rem;margin-bottom: 0.8rem;}
    .dual-upload-item {border: 1px solid #f0c6d9;padding: 1rem;border-radius: 12px;display: flex;flex-direction: column;justify-content: center;align-items: center;text-align: center;color: #d23481;font-weight: 600;gap: 0.5rem;min-height: auto;background: transparent;cursor: pointer;transition: background 0.2s;}
    #editDualUploadContainer .dual-upload-item:hover {background: #faf8fa;}
    .dual-upload-item input[type="file"] {display: none;}
    .single-upload-box {border: 1.5px dashed #f9c6dd;padding: 1.2rem;border-radius: 14px;display: flex;flex-direction: column;justify-content: center;align-items: center;text-align: center;margin-bottom: 0.8rem;min-height: 65px;}
    .single-upload-box input[type="file"] {display: none;}
    .upload-label {background: linear-gradient(90deg, #ea3b91 0%, #fec74f 100%);border-radius: 14px;padding: 0.5rem 1rem;color: white;font-weight: 700;cursor: pointer;user-select: none;transition: filter 0.3s ease;}
    .upload-label:hover {background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%);}
    .status-group {margin-bottom: 1rem;}
    .status-group label {margin-right: 1.5rem;font-weight: 700;cursor: pointer;color: #ea3b91;}
    .status-group input[type="radio"] {margin-right: 0.3rem;accent-color: #ea3b91;cursor: pointer;}
    .modal-footer {display: flex;justify-content: flex-end;gap: 1rem;}
    .btn-cancel {background: #dbdbdb;border: none;padding: 0.6rem 1.5rem;border-radius: 8px;font-weight: 700;cursor: pointer;color: #595959;transition: background-color 0.3s ease;}
    .btn-cancel:hover {background: #c4c4c4;}
    .btn-submit {background: linear-gradient(90deg, #ea3b91 0%, #fec74f 100%);border: none;padding: 0.6rem 1.8rem;border-radius: 8px;font-weight: 700;cursor: pointer;color: white;transition: background 0.3s ease;}
    .btn-submit:hover {background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%);}
    /* Template table */
    .template-table {width: 100%;border-collapse: collapse;background:#fffafb;border-radius:12px;overflow: hidden;}
    .template-table thead tr {background:#fde1f2;}
    .template-table th, .template-table td {padding:1rem;text-align:left;font-size:1.07em;border-bottom: 2px solid #fcc2f2;color: #d23481;}
    .template-table tbody tr:last-child td {border-bottom: none;}
    .template-table td {vertical-align: middle;}
    .template-table th {color:#e10994;font-weight: bold;}
    /* Action icons styles */
    td button {background:none;border:none;cursor:pointer;color:#d23481;font-size:1.2rem;margin-right: 8px;padding: 0;line-height: 1;}
    td button:last-child {margin-right: 0;}
    td button:hover {color: #ea5a9f;}
    /* Modal Overlay & container */
    .modal-overlay {position: fixed;top: 0; left: 0; right: 0; bottom: 0;background: rgba(128,128,128,0.6);display: flex;justify-content: center;align-items: center;z-index: 1000;overflow-y: auto;padding: 1rem;}
    .modal {background: #fff;border-radius: 12px;max-height: 90vh;overflow-y: auto;padding: 2rem;box-shadow: 0 8px 25px rgba(210,52,129,0.25);font-family: 'Poppins', sans-serif;box-sizing: border-box;position: relative;width: 480px;}
    /* Modal titles */
    h2.modal-title {font-family: 'Fredoka One', cursive;font-weight: 900;font-size: 28px;margin: 0 0 1rem 0;color: #8BC34A; }
    #editModal #editModalTitle {color: #8BC34A;}
    /* Delete modal  */
    #deleteModal h2.modal-title {color: #d32f2f;font-size: 24px;display: flex;align-items: center;gap: 0.5rem;}
    #deleteModal .icon-warning {font-size: 30px;color: #d32f2f;}
    #deleteModal p {font-size: 1rem;margin: 0.25rem 0 0.5rem 0;color: black;}
    #deleteModal p.warning-text {color: #d32f2f;font-weight: 600;margin-bottom: 1.5rem;}
    /* View modal */
    .view-modal-overlay {position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; justify-content: center; align-items: center; z-index: 1100; padding: 1rem;}
    .view-modal { background: linear-gradient(180deg,#fffafc 0%, #fff 100%); border-radius: 12px; inline-size: 760px; max-inline-size: calc(100% - 2rem); box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 1.25rem 1.5rem; box-sizing: border-box; position: relative; }
    .view-modal .title { font-family: 'Fredoka One', cursive; font-size: 34px; color: #ea3b91; margin: 0 0 0.6rem 0; }
    .view-avatar { position: absolute; top: 18px; right: 22px; display:flex; align-items:center; gap:0.35rem; }
    .avatar-circle { width:56px; height:56px; border-radius:50%; background: #fff; border: 4px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .avatar-circle img { width:100%; height:100%; object-fit:cover; display:block; }
    .avatar-dot { width:12px; height:12px; background:#e94b4b; border-radius:50%; transform: translate(-14px,-34px); box-shadow:0 0 0 3px rgba(255,255,255,0.85); }
    .view-modal .view-grid { display: flex; gap: 1.2rem; }
    .view-left { flex: 1 1 440px; }
    .view-right { flex: 0 0 320px; border-left: 1px dashed #f4c1d9; padding-inline-start: 1rem; text-align: left; }
    .status-label { display:block; color:#d23481; font-weight:700; margin-bottom:0.35rem; }
    .status-badge { display:inline-block; background:#f9dceb; color:#ea3b91; font-weight:700; padding:0.6rem 1rem; border-radius: 12px; margin-bottom: 1rem; }
    .view-field { margin-block-end: 0.8rem; }
    .view-field input { inline-size: 100%; padding: 0.7rem 0.9rem; border-radius: 12px; border: none; background: #fff6f9; color: #333; box-sizing: border-box; font-weight:600; }
    .view-label { font-weight:700; color:#d23481; margin-block-end:0.35rem; display:block; }
    .asset-title { font-weight:800; font-size:1.05rem; color:#333; margin-block-end:0.6rem; }
    .asset-config { margin-block-end: 0.8rem; }
    .asset-preview img { inline-size: 100%; block-size: auto; border-radius:8px; border:1px solid #e6d7df; display:block; }
    .view-modal .modal-actions { display:flex; justify-content:flex-end; gap:0.8rem; margin-block-start:1rem; }
    .btn-close { background:#efefef; border: none; padding:0.6rem 1rem; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-close {padding: 0.6rem 1.2rem;font-weight: 700;border-radius: 8px;border: 2px solid #ddd;background-color: #f0f0f0;color: #666;cursor: pointer;transition: background-color 0.3s ease;}
    .btn-close:hover {background-color: #dcdcdc;}
    .btn-gotoedit  {background: linear-gradient(90deg, #f645b1  0%, #f4b744 100%);   border:none; padding:0.6rem 1rem; border-radius:8px; color:#fff; font-weight:700; cursor:pointer; }
    .btn-gotoedit:hover {background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%); }
    /* Form labels and inputs */
    label {font-weight: 600;color: #4CAF50;display: block;margin-bottom: 0.2rem;font-size: 0.9rem;}
    input[type=text], select {width: 100%;padding: 0.5rem 0.8rem;font-size: 1rem;border: 1.5px solid #bdbdbd;border-radius: 8px;margin-bottom: 1rem;color: #333;font-weight: 500;box-sizing: border-box;}
    input[readonly] {background-color: #f9f9f9;border-color: #ddd;color: #999;font-weight: 600;cursor: not-allowed;}
    td button img {width: 16px;height: 16px;display: block;pointer-events: none; user-select: none;}
    td .action-icon {margin-right: 12px;}
    td .action-icon:last-child {margin-right: 0;}
    .modal-footer {display: flex;justify-content: flex-end;gap: 1rem;margin-top: 1rem;}
    button.btn-cancel {padding: 0.6rem 1.2rem;font-weight: 700;border-radius: 8px;border: 2px solid #ddd;background-color: #f0f0f0;color: #666;cursor: pointer;transition: background-color 0.3s ease;}
    button.btn-cancel:hover {background-color: #dcdcdc;}
    button.btn-confirm-delete {background: linear-gradient(90deg,#d32f2f 0%,#f57c00 100%);border: none;padding: 0.6rem 1.2rem;font-weight: 700;border-radius: 8px;color: white;cursor: pointer;transition: filter 0.3s ease;}
    button.btn-confirm-delete:hover { background: linear-gradient(90deg, #f57c00  0%,#d32f2f  100%);}
    button.btn-save {background: linear-gradient(90deg, #4caf50 0%, #cddc39 100%);border: none;padding: 0.6rem 1.4rem;font-weight: 700;border-radius: 8px;color: white;cursor: pointer;transition: filter 0.3s ease;}
    button.btn-save:hover { background: linear-gradient(90deg, #cddc39 0%,#4caf50  100%);}
    /* Edit modal layout */
    .edit-content {display: flex; gap: 0.6rem; flex-wrap: wrap;}
    .edit-left {flex: 1 1 200px;}
    .edit-right {flex: 1 1 220px; border-left: 1px solid #e0e0e0; padding-left: 0.6rem; text-align: center;}
    .preview-title {font-weight: 700; margin-bottom: 0.4rem; color: #4caf50; font-size: 0.95rem;}
    .preview-img {width: 100%; height: auto; border-radius: 8px; border: 1px solid #bdbdbd; margin-bottom: 0.6rem; max-height: 320px; object-fit: contain;}
    /* Compact edit modal specific rules */
    #editModal .modal { width: 720px; max-height: none; overflow-y: visible; padding: 1rem 1.25rem; }
    #editModal .modal .modal-footer { margin-top: 1rem; }
    .file-upload-label {background: linear-gradient(90deg, #4caf50 0%, #cddc39 100%);color: white;padding: 0.5rem 1rem;border-radius: 12px;font-weight: 700;font-size: 0.9rem;cursor: pointer;user-select: none;display: inline-block;transition: filter 0.3s ease;margin-bottom: 0.5rem;}
    .file-upload-label:hover {background: linear-gradient(90deg, #cddc39 0%,#4caf50  100%);}
    #editModal .upload-label {background:transparent;pointer-events: none; color: green;}
    #editModal .dual-upload-item {cursor: pointer;}
    #editModal .dual-upload-item input[type="file"] {display: none;width: 0;height: 0;}
    .file-status {color: #999;font-size: 0.85rem;font-weight: 500;margin-top: 0.3rem;pointer-events: none;}
    .file-upload-label:hover {filter: brightness(1.1);}
    input[type="file"] {display: none;}
    .usage-count {margin-bottom: 1rem;font-weight: 600;font-size: 0.9rem;color: #555;}
    @media (max-width: 650px) {
    .edit-content {flex-direction: column;}
    .edit-right {border-left: none;padding-left: 0;}}
    /* User Management Panel */
    .user { display: flex; gap:1rem; margin:2rem 0 0.8rem 0; align-items: center; }
    .user-controls { display: flex; gap:1rem; align-items: center; width: 100%; }
    .big-search { flex: 1 1 520px; padding: 0.95rem 1rem; font-size:1.05rem; border-radius: 12px; border: 1.5px solid #f0b9d6; background: #fff; color: #333; box-shadow: inset 0 1px 0 rgba(0,0,0,0.02); }
    .big-search::placeholder { color:#f0afcf; }
    .user-search-input { flex: none; padding:0.85rem 1rem; font-size:1.02em; border-radius:9px; border:1.7px solid #e10994; outline:none; background:#fff; }
    .user-select {padding:0.78rem 1rem; border-radius:9px; border:1.7px solid #e10994; background:#fff; font-size:1.02em; outline:none; min-width:160px;}
    .user-table {width: 100%;border-collapse: collapse;background:#fffafb;border-radius:12px;overflow: hidden;}
    .user-table thead tr {background:#fde1f2;}
    .user-table th, .user-table td {padding:1rem;text-align:left;font-size:1.07em;border-bottom: 2px solid #fcc2f2;color: #d23481;}
    .user-table tbody tr:last-child td {border-bottom: none;}
    .user-table td {vertical-align: middle;}
    .user-table th {color:#e10994;font-weight: bold;}
    .manage-link {color:#fa49c5; font-weight:700; cursor:pointer; text-decoration:none; font-size:1.11em; transition:text-decoration .2s;}
    .manage-link:hover {text-decoration:underline;}
    .tab-panel { animation: fadeIn .6s;}
    .deleteUserBtn{background: linear-gradient(90deg, #d32f2f 0%, #f57c00 100%); border: none; padding: 0.6rem 1.2rem; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; width: 100%;}
    .deleteUserBtn:hover { background: linear-gradient(90deg, #f57c00 0%, #d32f2f 100%);}
    .saveChangeBtn{background: linear-gradient(90deg, #4caf50 0%, #cddc39 100%); border: none; padding: 0.6rem 1rem; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; margin-right: 0.5rem;}
    .saveChangeBtn:hover { background: linear-gradient(90deg, #cddc39 0%, #4caf50 100%);}
    .closeManageBtn{background: #efefef; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 700; cursor: pointer;}
    .closeManageBtn:hover {background-color: #dcdcdc;}
    /* UPDATED FAVORITES SECTION */
    #section-favorites {user-select: none;display: none;}
    #section-favorites.active { display: block;}
    #section-favorites h2 {font-family: 'Fredoka One', cursive;font-size: 30px;margin-top: 0;color: #c32d6c;}
    .favorites-vertical-container {display: flex;gap: 40px;user-select: none;flex-wrap: wrap;padding-top: 30px;}
    .no-favorites-msg {font-style: italic;color: #f9acdb;user-select: none;text-align: center;padding: 20px;width: 100%;grid-column: 1 / -1;}
    .vertical-template-card.dragging {opacity: 0.5;transform: scale(0.95);box-shadow: 0 8px 25px rgba(210, 52, 129, 0.5);}
    .favorites-vertical-container.drop-zone {border: 2px dashed #ea5a9f;border-radius: 16px;min-height: 200px;display: flex;align-items: center;justify-content: center;background-color: rgba(234, 90, 159, 0.05);transition: all 0.3s ease;}
    .favorites-vertical-container.drop-zone.active {background-color: rgba(234, 90, 159, 0.1);border-color: #d23481;}
    .drop-message {color: #d23481;font-weight: 600;font-size: 1.2rem;text-align: center;padding: 20px;}
    /* Notification Toast Styles */
    #notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 50000;
        pointer-events: none;
    }
    .notification-toast {
        background: white;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        pointer-events: auto;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .notification-toast.success {
        border-left: 4px solid #10b981;
        color: #065f46;
    }
    .notification-toast.error {
        border-left: 4px solid #ef4444;
        color: #7f1d1d;
    }
    .notification-toast.warning {
        border-left: 4px solid #f59e0b;
        color: #78350f;
    }
    .notification-toast.info {
        border-left: 4px solid #3b82f6;
        color: #1e3a8a;
    }
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    .notification-toast.removing {
        animation: slideOut 0.3s ease-in forwards;
    }
    /* Activity Section */
    #section-activity { user-select: none; display: none; }
    #section-activity.active { display: block; }
    #section-activity h2 { font-family: 'Fredoka One', cursive; font-size: 30px; margin-top: 0; color: #c32d6c; }
    .activity-container { display: flex; flex-direction: column; gap: 22px; height: 100%; overflow-y: auto; }
    .activity-post { background: white; border-radius: 14px; border: 1px solid #f3c7d9; padding: 12px 14px; font-size: 14px; line-height: 1.3; color: #d72b7e; white-space: pre-line; word-break: break-word; }
    .activity-post.empty { font-style: italic; color: #f29dcc; border-color: #fddaeb; }
    /* FEED SECTION STYLES */
    #section-feed {user-select: none;display: none;}
    #section-feed.active {display: block;}
    #section-feed h2 {font-family: 'Fredoka One', cursive;font-size: 30px;margin-top: 0;color: #c32d6c;}
    .tabnav {display: flex;gap: 2rem;border-bottom: 2px solid #ea5a9f;margin-bottom: 1.2rem;user-select: none;}
    .tabnav button {background: none;border: none;cursor: pointer;font-weight: 600;font-size: 1rem;color: #d23481;border-bottom: 3px solid transparent;padding-bottom: 0.4rem;transition: color 0.3s, border-color 0.3s;}
    .tabnav button:hover {color: #ea5a9f;}
    .tabnav button.active {border-color: #ea5a9f;font-weight: 700;color: #ea5a9f;}
    .vertical-templates-container {display: flex;gap: 40px;user-select: none;flex-wrap: wrap;}
    .vertical-template-card {position: relative;width: 200px;height: 500px; padding: 16px;border-radius: 16px;background: linear-gradient(to bottom, #5e2e55, #765075);box-shadow: 0 1px 28px 10px rgb(169 42 89 / 0.2);display: flex;flex-direction: column;justify-content: flex-start;user-select: none;overflow: hidden;background-size: cover;background-position: center;transition: all 0.3s ease;}
    .template-photo-container {width: 100%;height: 380px; /* Increased height for bigger photos */position: relative;overflow: hidden;border-radius: 6px;background-color: rgba(255, 255, 255, 0.9);box-shadow: inset 0 0 3px #0070c0;}
    .template-photo-single {width: 100%;height: 100%;background-size: cover;background-position: center;position: relative;}
    .template-photo-multiple {display: grid;width: 100%;height: 100%;position: relative;}
    .template-photo-multiple.two-shots {grid-template-columns: 1fr 1fr;gap: 4px;}
    .template-photo-multiple.three-shots {grid-template-columns: 1fr 1fr;grid-template-rows: 1fr 1fr;gap: 4px;}
    .template-photo-multiple.four-shots {grid-template-columns: 1fr 1fr;grid-template-rows: 1fr 1fr;gap: 4px;}
    .photo-slot {background-size: cover;background-position: center;border-radius: 4px;}
    .sticker-overlay {position: absolute;top: 0;left: 0;width: 100%;height: 100%;pointer-events: none;z-index: 2;}
    .sticker {position: absolute;width: 40px;height: 40px;background-size: contain;background-repeat: no-repeat;background-position: center;cursor: grab;transition: transform 0.2s ease, box-shadow 0.2s ease;z-index: 3;}
    .sticker.dragging {cursor: grabbing;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);transform: scale(1.1);z-index: 10;}
    .sticker:hover {transform: scale(1.05);}
    .template-tags {margin-top: 8px;font-size: 0.75rem;padding: 20px;color: #f4cade;text-align: center;max-height: 40px;overflow: hidden;text-overflow: ellipsis;display: -webkit-box;line-clamp: 2;}
    .vertical-template-icons {position: absolute;top: 16px;right: 16px;display: flex;flex-direction: column;gap: 14px;user-select: none;opacity: 0;transition: opacity 0.3s ease;z-index: 5;}
    .vertical-template-card:hover .vertical-template-icons {opacity: 1;}
    .vertical-template-icons button {background: none;border: none;cursor: pointer;padding: 0;display: flex;justify-content: center;align-items: center;transition: transform 0.2s;}
    .vertical-template-icons button:hover {transform: scale(1.1);}
    .vertical-template-icons img {width: 24px;height: 24px;pointer-events: none;user-select: none;}
    .vertical-use-template-btn {background-color: #db2d73;border: none;border-radius: 8px;color: white;font-weight: 700;font-size: 1rem;padding: 0.75rem 1.25rem;cursor: pointer;display: flex;align-items: center;gap: 8px;user-select: none;box-shadow: 0 4px 10px rgb(219 45 115 / 0.7);transition: background-color 0.3s ease;user-select: none;opacity: 0;transition: opacity 0.3s ease;z-index: 3;position: relative;}
    .vertical-template-card:hover .vertical-use-template-btn {opacity: 1;}
    .vertical-use-template-btn img {width: 20px;height: 20px;filter: invert(100%);user-select: none;pointer-events: none;}
    .vertical-use-template-btn:hover,
    .vertical-use-template-btn:focus {background-color: #a31a62;outline: none;}
    /* Upload your template card */
    .template-upload-card {width: 200px; height: 500px; border: 2.4px solid #f4cade;border-radius: 16px;display: flex;flex-direction: column;justify-content: center;align-items: center;cursor: pointer;font-weight: 700;font-size: 1.35rem;color: #f4cade;transition: background-color 0.3s ease;user-select: none;}
    .template-upload-card > .plus-sign {font-size: 5rem;line-height: 1;margin-bottom: 8px;user-select: none;}
    .template-upload-card:hover,
    .template-upload-card:focus {background-color: #fce9f1;outline: none;}
    /* File upload input */
    #template-upload-input {display: none;}
    /* Favorite button active state */
    .favorite-active {filter: invert(23%) sepia(95%) saturate(2106%) hue-rotate(320deg) brightness(90%) contrast(101%);}
    .frame-2x6 {width: 100%;height: 380px;}
    .frame-4x6 {width: 100%;height: 450px;}
    /* Effect filters */
    .effect-none {filter: none;}
    .effect-bw {filter: grayscale(100%);}
    .effect-warm {filter: sepia(0.3) saturate(1.2) hue-rotate(-10deg);}
    .effect-cool {filter: sepia(0.2) saturate(0.8) hue-rotate(180deg) brightness(1.1);}
    .effect-retro {filter: sepia(0.5) contrast(1.2) saturate(1.3);}
    .effect-noir {filter: grayscale(100%) contrast(1.5) brightness(0.8);}
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @media (max-width:900px) {
      .template-management-actions {flex-direction:column;gap:1rem;}
      .upload-btn {width:100%;height:95px;}
      .template-search {width:100%;}
      .stats, .charts { flex-direction:column;}
      .user-management-search-row {flex-direction:column;gap:1rem;}
      .left-buttons span { display:none;}
      .sidebar { width:60px;}
      .main-content, .subnav { flex-direction:column; align-items:flex-start; gap:0.5rem;}
      .template-grid {grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));}
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar" aria-label="Sidebar Navigation">
      <div class="logo">
        <img src="Icons/11.svg" alt="Webooth logo" />
      </div>
      <div class="left-buttons">
        <button data-target="feed" aria-label="Feed" class="active">
          <img src="Icons 2/templates.svg" alt="Feed icon" />
          <span>Feed</span>
        </button>
        <button data-target="favorites" aria-label="Favorites">
          <img src="Icons 2/favorites.svg" alt="Favorites icon" />
          <span>Favorites</span>
        </button>
        <button data-target="activity" aria-label="Activity">
          <img src="Icons 2/activity.svg" alt="Activity icon" />
          <span>Activity</span>
        </button>
        <button data-target="logout" aria-label="Logout">
          <img src="Icons 2/logout.svg" alt="Logout icon" />
          <span>Logout</span>
        </button>
      </div>
    </nav>
    <main class="main-content" role="main">
      <header class="topbar">
        <h1>Admin Dashboard</h1>
        <div class="right-buttons">
          <button onclick="window.location.href='booth.html'">
            <img src="Icons/2.svg" alt="Booth icon" />
            Booth
          </button>
          <button onclick="window.location.href='finalprof.html'">
            <img src="Icons/4.svg" alt="Profile icon" />
            Profile
          </button>
          <button onclick="window.location.href='admin.html'">
            <img src="Icons/3.svg" alt="Admin icon" />
            Admin
          </button>
        </div>
      </header>
      <div class="subnav" role="tablist" aria-label="Main Content Tabs">
        <button role="tab" aria-selected="true" class="active" onclick="showTab(0)">Usage Stats</button>
        <button role="tab" aria-selected="false" onclick="showTab(1)">Template Management</button>
        <button role="tab" aria-selected="false" onclick="showTab(2)">User Management</button>
        <button role="tab" aria-selected="false" onclick="showTab(3)">Audit Trail</button>
      </div>
      <div id="tab-panels">
        <section class="tab-panel" style="display:block;">
          <section class="stats">
            <div class="stat-card">
              <h3>Total Users</h3>
              <p class="number" id="total-users">0</p>
              <p class="growth" id="user-growth">
                <i class="percentage"></i> 0% this week
              </p>
            </div>
            <div class="stat-card">
              <h3>Photos Captured</h3>
              <p class="number" id="photos-captured">0</p>
              <p class="growth" id="photo-growth">
                <i class="percentage"></i> 0% this week
              </p>
            </div>
          </section>
          <section class="charts">
            <div class="chart-card">
              <h3>New Users Created Per Day</h3>
              <div class="chart-placeholder" id="user-growth-chart" style="display:none;"></div>
              <p id="user-growth-summary" style="margin-top:0.8rem; color:#d23481; font-weight:600;">No user data available for the last 30 days.</p>
            </div>
            <div class="chart-card">
              <h3>User Status Distribution</h3>
              <div class="chart-placeholder" id="status-distribution-chart">[Pie Chart Placeholder]</div>
            </div>
            <div class="chart-card">
              <h3>Top Favorited Templates</h3>
              <div class="chart-placeholder" id="provider-distribution-chart" style="display:none;"></div>
              <div id="top-favorites-summary" style="margin-top:0.8rem; color:#d23481; font-weight:600;">
                No favorites data available.
              </div>
            </div>
          </section>
        </section>
        <section class="tab-panel" style="display:none;">
          <div class="template">
            <form class="template-search" onsubmit="event.preventDefault();">
              <div class="template-search-row-top">
                <input type="text" id="templateSearch" placeholder="Search Template Name..." />
              </div>
              <div class="template-search-row-bottom">
                <label for="shareFilter">Share</label>
                <select id="shareFilter">
                  <option value="">All</option>
                  <option value="shared">Shared</option>
                  <option value="private">Private</option>
                </select>
                <label for="ownerFilter">Owner</label>
                <input type="text" id="ownerFilter" placeholder="Search owner username" />
              </div>
            </form>
          </div>
          <table class="template-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Owner</th>
                <th>Frame</th>
                <th>Shots</th>
                <th>Shared</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="templateTableBody">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </section>
        <section class="tab-panel" style="display:none;">
          <div class="user">
            <div class="user-controls">
              <input 
              type="text" 
              id="userSearchInput" 
              class="user-select1" 
              style="border: 2px solid #e10994;; height: 48px; padding: 10px;" 
              placeholder="Search Username or Email..." 
              />
              <select id="userGroupFilter" class="user-select">
                <option>All groups</option>
                <option>User</option>
                <option>Admin</option>
              </select>
              <select id="userStatusFilter" class="user-select">
                <option>Status</option>
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
          </div>
          <table class="user-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>
        </section>
        <section class="tab-panel" style="display:none;">
          <div class="user">
            <div class="user-controls">
              <input 
              type="text" 
              id="auditSearchInput" 
              class="user-select1" 
              style="border: 2px solid #d23481;; height: 50px; padding: 10px;" 
              placeholder="Search Username or Action..." 
              />
              <select id="auditActionTypeFilter" class="user-select">
                <option value="">All actions</option>
              </select>
            </div>
          </div>
          <table class="user-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="auditTrailTableBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </section>
      </div>
      <section id="section-feed" class="section" role="region" aria-label="Feed Section" style="display:none;">
        <h2>Feed</h2>
        <nav class="tabnav" role="tablist" aria-label="Templates Tabs">
          <button role="tab" aria-selected="true" class="active" id="tab-shared-btn">Shared to Community</button>
          <button role="tab" aria-selected="false" id="tab-mytemplates-btn">My Templates</button>
        </nav>
        <section id="tab-shared" role="tabpanel" aria-labelledby="tab-shared-btn" style="display:block;">
          <div class="vertical-templates-container" aria-live="polite" aria-label="Shared templates grid">
            </div>
        </section>
        <section id="tab-mytemplates" role="tabpanel" aria-labelledby="tab-mytemplates-btn" style="display:none;">
          <div class="vertical-templates-container" aria-live="polite" aria-label="My templates grid">
          </div>
        </section>
      </section>
      <section id="section-favorites" class="section" role="region" aria-label="Favorites Section" style="display:none;">
        <h2>Favorites</h2>
        <div class="favorites-vertical-container" id="favoritesContainer" aria-live="polite">
          </div>
      </section>
      <section id="section-activity" class="section" role="region" aria-label="Activity Log Section" style="display:none;">
        <h2>Activity</h2>
        <div class="activity-container" aria-live="polite"></div>
      </section>
    </main>
  </div>
  <script>
    // Global app state used across dashboard (activities, templates)
    const state = { myTemplates: [], activities: [] };
    // Shared templates collection used by feed/favorites sections
    const sharedTemplates = Array.isArray(window.sharedTemplates) ? window.sharedTemplates : [];
    // Define missing helper to avoid runtime error if referenced
    function copyFirstTemplateToMyTemplates() {}
    // Upload Template modal logic (adapted from finalprof, uses API_ENDPOINT directly)
    (function(){
      const uploadModal = document.getElementById('upload-template-modal');
      const openUploadModalBtn = document.getElementById('open-upload-modal-btn');
      const uploadCloseBtn = document.getElementById('upload-close-btn');
      const publishBtn = document.getElementById('publishBtn');
      const backgroundUploadInput = document.getElementById('backgroundUpload');
      const stickersUploadInput = document.getElementById('stickersUpload');
      const shareToggle = document.getElementById('shareToggle');
      const tagsInput = document.getElementById('tagsInput');
      const frameSizeSelect = document.getElementById('frameSize');
      const shotsSelect = document.getElementById('shots');
      const templatePreview = document.getElementById('template-preview');
      const previewSide = document.getElementById('uploadPreviewSide');

      let uploadedBackground = null;
      let uploadedStickers = [];
      let currentEffect = 'none';

      function openUploadTemplateModal(){
        uploadModal.style.display = 'flex';
        resetUploadModal();
      }
      window.openUploadTemplateModal = openUploadTemplateModal;

      function closeUploadModal(){
        uploadModal.style.display = 'none';
      }

      function resetUploadModal(){
        backgroundUploadInput.value='';
        stickersUploadInput.value='';
        uploadedBackground=null;
        uploadedStickers=[];
        shareToggle.checked=false;
        tagsInput.value='';
        frameSizeSelect.value='2x6';
        shotsSelect.value='1';
        currentEffect='none';
        Array.from(document.querySelectorAll('.effect-option')).forEach(b=>b.classList.toggle('selected', b.dataset.effect==='none'));
        templatePreview.innerHTML='<div class="preview-placeholder">Template preview will appear here</div>';
        templatePreview.className='preview-image size-2x6';
        previewSide.classList.remove('is-4x6');
        publishBtn.disabled = true;
        const titleEl = document.getElementById('upload-template-title');
        if (titleEl) titleEl.textContent='Upload Template';
        publishBtn.textContent='Publish';
      }

      function readFileAsDataURL(file){
        return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); });
      }

      // Effects selection
      Array.from(document.querySelectorAll('.effect-option')).forEach(option=>{
        option.addEventListener('click', ()=>{
          document.querySelectorAll('.effect-option').forEach(o=>o.classList.remove('selected'));
          option.classList.add('selected');
          currentEffect = option.dataset.effect;
          updatePreview();
        });
      });

      if (backgroundUploadInput) {
        backgroundUploadInput.addEventListener('change', async ()=>{
          if (backgroundUploadInput.files.length===0){ uploadedBackground=null; updatePreview(); }
          else { try { uploadedBackground = await readFileAsDataURL(backgroundUploadInput.files[0]); updatePreview(); } catch(e){ console.error(e); uploadedBackground=null; } }
          checkPublish();
        });
      }

      if (stickersUploadInput) {
        stickersUploadInput.addEventListener('change', async ()=>{
          if (stickersUploadInput.files.length===0){ uploadedStickers=[]; }
          else { try { const reads = Array.from(stickersUploadInput.files).map(readFileAsDataURL); uploadedStickers = await Promise.all(reads); } catch(e){ console.error(e); uploadedStickers=[]; } }
          updatePreview();
        });
      }

      function createPreviewTemplate(frameSize, shots, backgroundUrl, effect, stickerPositions){
        let shotAspectRatio='4/3'; let layoutClass='';
        if (frameSize==='2x6'){ shotAspectRatio='4/3'; }
        else if (frameSize==='4x6'){
          layoutClass=' layout-4x6';
          if (shots===4){ shotAspectRatio='4/3'; layoutClass+=' layout-grid-2x2 layout-4shots'; }
          else if (shots===3){ shotAspectRatio='1/1'; layoutClass+=' layout-grid-3shots'; }
          else if (shots===2){ shotAspectRatio='3/2'; layoutClass+=' layout-2cols'; }
          else if (shots===1){ shotAspectRatio='3/2'; layoutClass+=' layout-single'; }
        }
        let templateHTML = `<div class="photobooth-template-container${layoutClass}" style="background-image: ${backgroundUrl.startsWith('#')?'none':`url('${backgroundUrl}')`}; background-color: ${backgroundUrl.startsWith('#')?backgroundUrl:'transparent'}; width:100%; height:100%;">`;
        const photoDivs = Array.from({length:shots}, (_,i)=>`<div class=\"photo-strip-image\" style=\"aspect-ratio:${shotAspectRatio}; background-color:#d1d5db; display:flex; align-items:center; justify-content:center; color:#4b5563; font-size:10px; border-radius:4px;\"><div class=\"photo-slot effect-${effect}\" style=\"padding:10px; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9);\">Photo Slot ${i+1}</div></div>`).join('');
        templateHTML += photoDivs;
        templateHTML += `<div id="text-overlay-layer"></div>`;
        if (stickerPositions.length>0){
          const stickersHTML = stickerPositions.map((s,idx)=>{
            const pos = s.top? {top:s.top,left:s.left,rotate:s.rotate||'0deg'} : {top:'10%', left:'10%', rotate:'0deg'};
            const src = typeof s==='string'? s : s.src;
            return `<div class=\"sticker\" style=\"background-image:url('${src}'); top:${pos.top}; left:${pos.left}; transform: rotate(${pos.rotate}); width:40px; height:40px; pointer-events:auto;\" data-sticker-index=\"${idx}\"></div>`;
          }).join('');
          templateHTML += `<div class=\"sticker-overlay\">${stickersHTML}</div>`;
        }
        templateHTML += `<div class=\"template-footer\">Webooth Template Preview</div>`;
        templateHTML += `</div>`;
        return templateHTML;
      }

      function addStickerDragFunctionality(container){
        const stickers = container.querySelectorAll('.photobooth-template-container .sticker');
        stickers.forEach(sticker=>{
          const handle = document.createElement('div');
          handle.className='sticker-resize-handle';
          sticker.appendChild(handle);
          let dragged=null, offX=0, offY=0, resizing=false, startW=0, startH=0, startX=0, startY=0;
          function start(e){
            const rect=handle.getBoundingClientRect();
            const cx = e.type==='mousedown'? e.clientX : e.touches[0].clientX;
            const cy = e.type==='mousedown'? e.clientY : e.touches[0].clientY;
            const onHandle = cx>=rect.left && cx<=rect.right && cy>=rect.top && cy<=rect.bottom;
            if (onHandle){ resizing=true; startW=sticker.offsetWidth; startH=sticker.offsetHeight; startX=cx; startY=cy; document.addEventListener('mousemove', resize); document.addEventListener('mouseup', stop); document.addEventListener('touchmove', resize,{passive:false}); document.addEventListener('touchend', stop);} else { dragged=sticker; const r=dragged.getBoundingClientRect(); offX=cx-r.left; offY=cy-r.top; document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stop); document.addEventListener('touchmove', drag,{passive:false}); document.addEventListener('touchend', stop);} }
          function drag(e){ if(!dragged) return; e.preventDefault(); const cont=dragged.closest('.photobooth-template-container'); if(!cont) return; const cr=cont.getBoundingClientRect(); const cx=e.type==='mousemove'? e.clientX: e.touches[0].clientX; const cy=e.type==='mousemove'? e.clientY: e.touches[0].clientY; const nl=cx-cr.left-offX; const nt=cy-cr.top-offY; dragged.style.left=`${nl}px`; dragged.style.top=`${nt}px`; dragged.style.transform='none'; }
          function resize(e){ if(!resizing) return; e.preventDefault(); const cx=e.type==='mousemove'? e.clientX: e.touches[0].clientX; const cy=e.type==='mousemove'? e.clientY: e.touches[0].clientY; const dx=cx-startX; const dy=cy-startY; const m=Math.max(dx,dy); sticker.style.width=`${Math.max(30,startW+m)}px`; sticker.style.height=`${Math.max(30,startH+m)}px`; }
          function stop(){ dragged=null; resizing=false; document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stop); document.removeEventListener('touchmove', drag); document.removeEventListener('touchend', stop); document.removeEventListener('mousemove', resize); document.removeEventListener('touchmove', resize); }
          sticker.addEventListener('mousedown', start); sticker.addEventListener('touchstart', start, {passive:false});
        });
      }

      function updatePreview(){
        const frameSize = frameSizeSelect.value; const shots = parseInt(shotsSelect.value);
        const backgroundValue = uploadedBackground || '#FFFFFF';
        const stickers = uploadedStickers.map(src=>({src}));
        templatePreview.classList.remove('size-2x6','size-4x6');
        templatePreview.classList.add(`size-${frameSize}`);
        previewSide.classList.toggle('is-4x6', frameSize==='4x6');
        if (!uploadedBackground){ templatePreview.innerHTML='<div class="preview-placeholder">Template preview will appear here</div>'; publishBtn.disabled=true; return; }
        const html = createPreviewTemplate(frameSize, shots, backgroundValue, currentEffect, stickers);
        templatePreview.innerHTML = html;
        addStickerDragFunctionality(templatePreview);
        checkPublish();
      }

      function checkPublish(){ publishBtn.disabled = !uploadedBackground; }

      async function handlePublishTemplate(){
        if (!uploadedBackground) return;
        try {
          publishBtn.disabled=true; publishBtn.textContent='Publishing...';
          const container = templatePreview.querySelector('.photobooth-template-container');
          const canvas = await window.html2canvas(container, {backgroundColor:null, scale:2, logging:false, useCORS:true, allowTaint:true});
          const templateImgDataUrl = canvas.toDataURL('image/png');
          const stickers = Array.from(container.querySelectorAll('.sticker')).map((st,idx)=>({
            src: (uploadedStickers[idx] || ''),
            top: st.style.top || '10%',
            left: st.style.left || '10%',
            rotate: st.style.transform || '0deg'
          }));
          const templateId = (window.crypto?.randomUUID && crypto.randomUUID()) || (Math.random().toString(36).slice(2)+Date.now());
          const payload = {
            action: 'saveTemplateState',
            user_id: ADMIN_USER_ID,
            template_id: templateId,
            template_state: {
              sticker: stickers.length? JSON.stringify(stickers): null,
              text: tagsInput.value.trim() || `Uploaded Template` ,
              font: null,
              text_color: null,
              background: uploadedBackground,
              show_logo: String(false),
              show_date: String(false),
              show_time: String(false),
              frame_size: frameSizeSelect.value,
              shot_count: shotsSelect.value,
              share: String(!!shareToggle.checked),
              effects: currentEffect,
              template_img: templateImgDataUrl,
              name: tagsInput.value.trim() || `Uploaded Template`,
            }
          };
          const res = await fetch(API_ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          const json = await res.json();
          if (!json.success) throw new Error(json.error || 'Failed to save template');
          showToast('Template uploaded', 'success');
          closeUploadModal();
          if (typeof fetchAdminTemplates==='function') await fetchAdminTemplates();
        } catch(e){ console.error('handlePublishTemplate error:', e); showToast('Failed to upload template','error'); }
        finally { publishBtn.disabled=false; publishBtn.textContent='Publish'; }
      }

      // Events
      if (openUploadModalBtn) openUploadModalBtn.addEventListener('click', openUploadTemplateModal);
      if (uploadCloseBtn) uploadCloseBtn.addEventListener('click', ()=>{ closeUploadModal(); });
      if (uploadModal) uploadModal.addEventListener('click', (e)=>{ if (e.target===uploadModal) closeUploadModal(); });
      if (publishBtn) publishBtn.addEventListener('click', handlePublishTemplate);
      if (frameSizeSelect) frameSizeSelect.addEventListener('change', updatePreview);
      if (shotsSelect) shotsSelect.addEventListener('change', updatePreview);
    })();
  </script>
  <!-- Upload Template Modal copied from finalprof (UI) -->
  <div id="upload-template-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="upload-template-title" style="display:none;">
    <div class="upload-template-modal">
      <button class="upload-close-btn" id="upload-close-btn" aria-label="Close upload modal">&times;</button>
      <div class="upload-preview-side" id="uploadPreviewSide">
        <div class="preview-title">Preview</div>
        <div class="preview-image size-2x6" id="template-preview">
          <div class="preview-placeholder">Template preview will appear here</div>
        </div>
      </div>
      <div class="upload-controls-side">
        <h2 class="modal-title" id="upload-template-title">Upload Template</h2>
        <div class="layout-section">
          <div class="section-heading">Layout</div>
          <div class="layout-options">
            <div class="layout-option">
              <label for="frameSize">Frame Size</label>
              <select id="frameSize" name="frameSize" required>
                <option value="2x6">2 x 6 inches</option>
                <option value="4x6">4 x 6 inches</option>
              </select>
            </div>
            <div class="layout-option">
              <label for="shots">Shots</label>
              <select id="shots" name="shots" required>
                <option value="1">1 shot</option>
                <option value="2">2 shots</option>
                <option value="3">3 shots</option>
                <option value="4">4 shots</option>
              </select>
            </div>
          </div>
        </div>
        <div class="upload-section">
          <div class="section-heading">Upload background image here</div>
          <label for="backgroundUpload" class="upload-box" tabindex="0" role="button">
            <div class="upload-text">in jpeg or png format</div>
            <input type="file" id="backgroundUpload" class="upload-template-input" accept=".jpeg,.jpg,.png" />
          </label>
        </div>
        <div class="effects-section">
          <div class="section-heading">Effects</div>
          <div class="effects-grid">
            <button type="button" class="effect-option selected" data-effect="none">None</button>
            <button type="button" class="effect-option" data-effect="bw">B&W</button>
            <button type="button" class="effect-option" data-effect="warm">Warm</button>
            <button type="button" class="effect-option" data-effect="cool">Cool</button>
            <button type="button" class="effect-option" data-effect="retro">Retro</button>
            <button type="button" class="effect-option" data-effect="noir">Noir</button>
          </div>
        </div>
        <div class="upload-section">
          <div class="section-heading">Upload sticker pack design here</div>
          <label for="stickersUpload" class="upload-box" tabindex="0" role="button">
            <div class="upload-text">in png format</div>
            <input type="file" id="stickersUpload" class="upload-template-input" accept=".png" multiple />
          </label>
        </div>
        <div class="modal-divider"></div>
        <div class="share-section">
          <input type="checkbox" id="shareToggle" class="toggle-input" />
          <label for="shareToggle">Share to community</label>
        </div>
        <div class="tags-section">
          <input type="text" id="tagsInput" class="tags-input" placeholder="Template name..." aria-label="Template name" maxlength="50" />
        </div>
        <div class="publish-section">
          <button id="publishBtn" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="deleteModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
    <div class="modal">
      <h2 class="modal-title" id="deleteModalTitle">
        <i class="fas fa-exclamation-triangle icon-warning" aria-hidden="true"></i>
        Confirm Deletion
      </h2>
      <p id="deleteMessage">Are you sure you want to permanently delete this template?</p>
      <p class="warning-text">This action cannot be undone and will be logged in the Audit Trail.</p>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn-confirm-delete" onclick="confirmDelete()">Confirm Deletion</button>
      </div>
    </div>
  </div>
    <div class="view-modal-overlay" id="viewModal" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
      <div class="view-modal" role="document">
        <div class="title" id="viewModalTitle">Template Details</div>
        <div class="view-grid">
          <div class="view-left">
            <label class="status-label">Template Status</label>
            <div class="status-badge" id="viewStatus">Active</div>
            <div class="view-field">
              <label class="view-label">Template Name</label>
              <input type="text" id="viewTemplateName" readonly />
            </div>
            <div class="view-field">
              <label class="view-label">Number of Shots</label>
              <input type="text" id="viewShotCount" readonly />
            </div>
            <div class="view-field">
              <label class="view-label">Type</label>
              <input type="text" id="viewType" readonly />
            </div>
            <div class="view-field" style="margin-top:0.6rem;">
              <label class="view-label">Effects / Filter</label>
              <input type="text" id="viewEffects" readonly />
            </div>
          </div>
          <div class="view-right">
            <div class="asset-title">Template Preview</div>
            <div class="asset-preview">
              <img id="viewTemplatePreviewImg" class="preview-img" alt="Template preview" />
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-close" onclick="closeViewModal()">Close</button>
          <button class="btn-gotoedit" onclick="closeViewModal(); openEditModal(CURRENT_VIEWED_TEMPLATE)">Go to Edit</button>
        </div>
      </div>
    </div>
    <div class="modal-overlay" id="editModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modal">
      <h2 class="modal-title" id="editModalTitle">Edit Template</h2>
      <form id="editForm" onsubmit="event.preventDefault(); saveChanges();">
        <div class="edit-content">
          <div class="edit-left">
            <input type="hidden" id="editTemplateId" />
            <label for="editTemplateName">Template Name</label>
            <input type="text" id="editTemplateName" name="templateName" required />
            <label for="editShare">Share to Community</label>
            <select id="editShare" name="share" required>
              <option value="true">True</option>
              <option value="false">False</option>
            </select>

            <label for="editEffects">Effects / Filter</label>
            <select id="editEffects" name="effects">
              <option value="none">None</option>
              <option value="bw">Black &amp; White</option>
              <option value="warm">Warm</option>
              <option value="cool">Cool</option>
              <option value="retro">Retro</option>
              <option value="noir">Noir</option>
            </select>

            <label for="editStatus">Template Status</label>
            <select id="editStatus" name="templateStatus" required>
              <option value="Active">Active</option>
              <option value="Draft">Draft</option>
              <option value="Needs Review">Needs Review</option>
            </select>
          </div>
          <div class="edit-right">
            <div class="preview-title">Current Asset Preview</div>
            <div id="assetPreviewContainer"></div>
            <div id="editFilterUploadContainer" style="margin-top: 1rem; display:none;">
              <label for="replaceFilterFile" class="file-upload-label" tabindex="0">Replace Main Asset File</label>
              <input type="file" id="replaceFilterFile" name="replaceFilterFile" accept=".png,.json" />
            </div>
            <div id="editDualUploadContainer" style="margin-top: 1rem; display:none;">
              <p class="upload-instruction">Replace Dual Size Assets</p>
              <div class="dual-upload-group">
                <div class="dual-upload-item" onclick="document.getElementById('editReplace2x6File').click();">
                  <label class="upload-label" for="editReplace2x6File">Upload New 2x6 File</label>
                  <div class="file-status">No file selected</div>
                  <input type="file" id="editReplace2x6File" name="editReplace2x6File" accept=".png" />
                </div>
                <div class="dual-upload-item" onclick="document.getElementById('editReplace4x6File').click();">
                  <label class="upload-label" for="editReplace4x6File">Upload New 4x6 File</label>
                  <div class="file-status">No file selected</div>
                  <input type="file" id="editReplace4x6File" name="editReplace4x6File" accept=".png" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="margin-top: 1.5rem;">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-overlay" id="manageUserModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="manageUserTitle">
    <div class="modal" style="width: 700px; max-height: 100vh; overflow-y: auto;">
      <h2 id="manageUserTitle" style="font-family: 'Fredoka One', cursive; font-size: 28px; color: #ea3b91; margin: 0 0 1.5rem 0;">Manage User</h2>
      <div style="display: flex; border-bottom: 2px solid #f4c1d9; margin-bottom: 1.5rem;">
        <button id="accountDetailsTab" class="tab-button active" onclick="switchTab('accountDetails')" style="flex: 1; padding: 0.5rem; background: none; border: none; border-bottom: 3px solid #ea3b91; color: #ea3b91; font-weight: 700; cursor: pointer;">Account Details</button>
        <button id="activityContentsTab" class="tab-button" onclick="switchTab('activityContents')" style="flex: 1; padding: 0.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #d23481; font-weight: 700; cursor: pointer;">Activity & Contents</button>
      </div>
      <div id="accountDetailsContent" class="tab-content" style="display: block; overflow-y: auto;">
        <input type="hidden" id="manageUserId" />
        <div style="display: flex; gap: 2rem;">
          <div style="flex: 1;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div>
                <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.3rem;">Username</label>
                <input type="text" id="manageUsername" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff6f9; color: #333;" />
              </div>
              <div>
                <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.3rem;">User Email</label>
                <input type="text" id="manageEmail" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff6f9; color: #333;" />
              </div>
              <div>
                <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.3rem;">Joined</label>
                <input type="text" id="manageJoined" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff6f9; color: #333;" />
              </div>
              <div>
                <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.3rem;">Total Photos</label>
                <input type="text" id="manageTotalPhotos" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff6f9; color: #333;" />
              </div>
            </div>
          </div>
          <div style="flex: 1;">
            <div style="margin-bottom: 2rem;">
              <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.5rem;">Account Status</label>
              <select id="manageStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff; color: #333;">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div style="margin-bottom: 2rem;">
              <label style="font-weight: 600; color: #ea3b91; display: block; margin-bottom: 0.5rem;">User Role</label>
              <select id="manageRole" style="width: 100%; padding: 0.5rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff; color: #333;">
                <option value="User">User</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            <button id="deleteUserBtn" class="deleteUserBtn">Delete User</button>
          </div>
        </div>
      </div>
      <div id="activityContentsContent" class="tab-content" style="display: none; overflow-y: auto; overflow-x: hidden;">
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <div>
            <h3 style="font-family: 'Fredoka One', cursive; font-size: 20px; color: #d23481; margin-bottom: 1rem;">Logs</h3>
            <div style="padding: 1rem; border: 1px solid #f4c1d9; border-radius: 8px; background: #fff6f9; min-height: 300px; max-height: 400px; overflow-y: auto;">
              <div id="manageUserActivityList" style="display: flex; flex-direction: column; gap: 0.8rem; color: #d23481;">
                <p style="color: #999; font-style: italic;">Loading activity logs...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
        <button onclick="saveChangesUser()" class="saveChangeBtn">Save Changes</button>
        <button onclick="closeManageUserModal()" class="closeManageBtn">Close</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="deleteUserModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="deleteUserModalTitle">
    <div class="modal">
      <h2 class="modal-title" id="deleteUserModalTitle">
        <img src="icons 3/warn.svg" alt="Warning Icon" style="display: block; margin: 0 auto; width: 50px; height: 50px;" />
      </h2>
      <p style="font-size: 1rem; margin: 0.25rem 0 0.5rem 0; color: grey; text-align: center;">Are you sure you want to permanently delete this user?</p>
      <p class="warning-text" style="color: #d32f2f; font-weight: 600; margin-bottom: 1.5rem; text-align: center;">This action cannot be undone and will be logged in the audit trail.</p>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeDeleteUserModal()">Cancel</button>
        <button class="btn-confirm-delete" onclick="confirmDeleteUser()">Complete Deletion</button>
      </div>
    </div>
  </div>

  <script>

    // Function to create My Template card - VERTICAL DESIGN
    function createMyTemplateCard(template) {
      const article = document.createElement('article');
      article.className = 'vertical-template-card';
      article.draggable = true;
      article.dataset.templateId = template.id;
      article.dataset.templateType = 'my';
      
      // Set background image if available
      if (template.photos && template.photos.length > 0) {
        article.style.backgroundImage = `url('${template.photos[0]}')`;
      }
      
      article.setAttribute('aria-label', `My template: ${template.name}`);

      // Template photo container
      const photoContainer = document.createElement('div');
      photoContainer.className = 'template-photo-container';
      
      // Create photo layout based on shots
      const shots = parseInt(template.shots || 1);
      const frameSize = template.frameSize || '2x6';
      const effect = template.effect || 'none';
      
      if (shots === 1) {
        const photoDiv = document.createElement('div');
        photoDiv.className = `template-photo-single frame-${frameSize} effect-${effect}`;
        photoDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        
        photoContainer.appendChild(photoDiv);
      } else {
        const multipleContainer = document.createElement('div');
        multipleContainer.className = `template-photo-multiple ${shots}-shots frame-${frameSize}`;
        
        for (let i = 0; i < shots; i++) {
          const photoSlot = document.createElement('div');
          photoSlot.className = `photo-slot effect-${effect}`;
          photoSlot.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
          multipleContainer.appendChild(photoSlot);
        }
        
        photoContainer.appendChild(multipleContainer);
      }

      // Add stickers scattered across the entire card
      if (template.photos && template.photos.length > 1) {
        const stickerOverlay = document.createElement('div');
        stickerOverlay.className = 'sticker-overlay';
        
        // Use saved positions if available, otherwise use default positions
        const defaultPositions = [
          { top: '10%', left: '10%', rotate: '5deg' },
          { top: '15%', left: '80%', rotate: '-10deg' },
          { top: '50%', left: '20%', rotate: '15deg' },
          { top: '60%', left: '70%', rotate: '-5deg' },
          { top: '80%', left: '30%', rotate: '10deg' },
          { top: '85%', left: '85%', rotate: '-15deg' }
        ];
        
        template.photos.slice(1).forEach((sticker, index) => {
          const savedPosition = template.stickerPositions && template.stickerPositions[index];
          const pos = savedPosition ? 
            { top: savedPosition.top, left: savedPosition.left, rotate: '0deg' } : 
            defaultPositions[index % defaultPositions.length];
          
          const stickerDiv = document.createElement('div');
          stickerDiv.className = 'sticker';
          stickerDiv.style.backgroundImage = `url('${sticker}')`;
          stickerDiv.style.top = pos.top;
          stickerDiv.style.left = pos.left;
          stickerDiv.style.transform = `rotate(${pos.rotate})`;
          stickerDiv.setAttribute('data-sticker-index', index);
          stickerOverlay.appendChild(stickerDiv);
        });
        
        article.appendChild(stickerOverlay);
      }

      // Template tags
      const tagsDiv = document.createElement('div');
      tagsDiv.className = 'template-tags';
      tagsDiv.textContent = template.tags || '';

      // Use button
      const useBtn = document.createElement('button');
      useBtn.className = 'vertical-use-template-btn';
      useBtn.setAttribute('aria-label', 'Use this template');
      useBtn.type = 'button';
      useBtn.innerHTML = `<img src="Icons/2.svg" alt="Camera icon" /> Use this template`;
      useBtn.addEventListener('click', () => {
        showToast(`Using template: ${template.name}`, 'success');
      });

      // Icon buttons - FAVORITE, EDIT, AND DELETE
      const iconsDiv = document.createElement('div');
      iconsDiv.className = 'vertical-template-icons';
      iconsDiv.setAttribute('role', 'group');
      iconsDiv.setAttribute('aria-label', 'Template controls');

      // Favorite button
      const favoriteBtn = document.createElement('button');
      favoriteBtn.type = 'button';
      favoriteBtn.setAttribute('aria-label', template.favorite ? 'Remove from favorites' : 'Add to favorites');
      favoriteBtn.setAttribute('title', template.favorite ? 'Remove from favorites' : 'Add to favorites');
      favoriteBtn.innerHTML = '<img src="Icons 2/save1.svg" alt="Favorite icon" />';
      
      // Add active class if template is favorited
      if (template.favorite) {
        favoriteBtn.querySelector('img').classList.add('favorite-active');
      }
      
      favoriteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMyTemplateFavorite(template.id);
      });

      // EDIT BUTTON 
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.setAttribute('aria-label', 'Edit template');
      editBtn.setAttribute('title', 'Edit template');
      editBtn.innerHTML = '<img src="Icons 2/btnedit1.svg" alt="Edit icon" />';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        showToast(`Edit template: ${template.name}`, 'info');
      });

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.setAttribute('aria-label', 'Delete template');
      deleteBtn.setAttribute('title', 'Delete template');
      deleteBtn.innerHTML = '<img src="Icons 2/btndel1.svg" alt="Delete icon" />';
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this template?')) {
          state.myTemplates = state.myTemplates.filter(t => t.id !== template.id);
          renderMyTemplates();
          renderFavorites(); 
          addActivity(`Template "${template.name}" deleted from My Templates`);
        }
      });

      // Add buttons to icons container
      iconsDiv.appendChild(favoriteBtn);
      iconsDiv.appendChild(editBtn); 
      iconsDiv.appendChild(deleteBtn);

      // Add drag events to the my template card
      article.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', template.id);
        e.dataTransfer.setData('template-type', 'my');
        article.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'copy';
      });
      
      article.addEventListener('dragend', () => {
        article.classList.remove('dragging');
      });

      // Assemble the card
      article.appendChild(photoContainer);
      article.appendChild(tagsDiv);
      article.appendChild(useBtn);
      article.appendChild(iconsDiv);

      return article;
    }

    // Toggle shared template favorite
    function toggleSharedTemplateFavorite(templateId) {
      const template = sharedTemplates.find(t => t.id === templateId);
      if (template) {
        template.favorite = !template.favorite;
        renderSharedTemplates();
        renderFavorites();
        addActivity(`Template "${template.name}" ${template.favorite ? 'added to' : 'removed from'} favorites`);
      }
    }

    // Toggle my template favorite
    function toggleMyTemplateFavorite(templateId) {
      const template = state.myTemplates.find(t => t.id === templateId);
      if (template) {
        template.favorite = !template.favorite;
        renderMyTemplates();
        renderFavorites();
        addActivity(`Template "${template.name}" ${template.favorite ? 'added to' : 'removed from'} favorites`);
      }
    }

    // Render shared templates grid 
    function renderSharedTemplates() {
      const sharedContainer = document.querySelector('#tab-shared .vertical-templates-container');
      sharedContainer.innerHTML = '';
      
      if (sharedTemplates.length === 0) {
        sharedContainer.innerHTML = `
          <div class="empty-state">
            <img src="Icons 2/templates.svg" alt="No templates">
            <h3>No Shared Templates Yet</h3>
            <p>When community members share templates, they'll appear here.</p>
            <button onclick="showToast('Creating your first template!', 'info')">Create Your First Template</button>
          </div>
        `;
      } else {
        sharedTemplates.forEach(tpl => {
          const card = createSharedTemplateCard(tpl);
          sharedContainer.appendChild(card);
        });
      }
    }

    // Function to render My Templates section
    function renderMyTemplates() {
      const myTemplatesContainer = document.querySelector('#tab-mytemplates .vertical-templates-container');
      
      // Add existing templates if any
      if (state.myTemplates && state.myTemplates.length > 0) {
        state.myTemplates.forEach(template => {
          const templateCard = createMyTemplateCard(template);
          myTemplatesContainer.appendChild(templateCard);
        });
      }
    }

    // Tab switching for templates
    const tabSharedBtn = document.getElementById('tab-shared-btn');
    const tabMyTemplatesBtn = document.getElementById('tab-mytemplates-btn');
    const tabShared = document.getElementById('tab-shared');
    const tabMyTemplates = document.getElementById('tab-mytemplates');

    tabSharedBtn.addEventListener('click', () => {
      tabShared.style.display = 'block';
      tabMyTemplates.style.display = 'none';
      tabSharedBtn.classList.add('active');
      tabSharedBtn.setAttribute('aria-selected', 'true');
      tabMyTemplatesBtn.classList.remove('active');
      tabMyTemplatesBtn.setAttribute('aria-selected', 'false');
      renderSharedTemplates();
    });

    tabMyTemplatesBtn.addEventListener('click', () => {
      tabShared.style.display = 'none';
      tabMyTemplates.style.display = 'block';
      tabMyTemplatesBtn.classList.add('active');
      tabMyTemplatesBtn.setAttribute('aria-selected', 'true');
      tabSharedBtn.classList.remove('active');
      tabSharedBtn.setAttribute('aria-selected', 'false');
      renderMyTemplates();
    });
    // Render favorites grid with vertical template design
    const favoritesContainer = document.getElementById('favoritesContainer');
    
    function renderFavorites() {
      favoritesContainer.innerHTML = '';
      
      // Combine favorites from both shared and my templates
      const sharedFavorites = sharedTemplates.filter(t => t.favorite);
      const myFavorites = state.myTemplates.filter(t => t.favorite);
      const allFavorites = [...sharedFavorites, ...myFavorites];
      
      if (allFavorites.length === 0) {
        const noFav = document.createElement('div');
        noFav.className = 'no-favorites-msg';
        noFav.textContent = 'No favorites yet. Click the heart icon on templates to add them to favorites, or drag templates here from the Feed.';
        favoritesContainer.appendChild(noFav);
        return;
      }
      
      // Create vertical template cards for each favorite
      allFavorites.forEach(template => {
        const templateCard = createFavoriteTemplateCard(template);
        favoritesContainer.appendChild(templateCard);
      });
      
      // Set up drag and drop functionality
      setupDragAndDrop();
    }

    // Create a favorite template card with vertical design
    function createFavoriteTemplateCard(template) {
      const article = document.createElement('article');
      article.className = 'vertical-template-card';
      article.draggable = true;
      article.dataset.templateId = template.id;
      article.dataset.templateType = template.shareToCommunity ? 'shared' : 'my';
      
      // Set background image if available
      if (template.photos && template.photos.length > 0) {
        article.style.backgroundImage = `url('${template.photos[0]}')`;
      }
      
      article.setAttribute('aria-label', `Favorite template: ${template.name}`);

      // Template photo container
      const photoContainer = document.createElement('div');
      photoContainer.className = 'template-photo-container';
      
      // Create photo layout based on shots
      const shots = parseInt(template.shots || 1);
      const frameSize = template.frameSize || '2x6';
      const effect = template.effect || 'none';
      
      if (shots === 1) {
        const photoDiv = document.createElement('div');
        photoDiv.className = `template-photo-single frame-${frameSize} effect-${effect}`;
        photoDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        
        photoContainer.appendChild(photoDiv);
      } else {
        const multipleContainer = document.createElement('div');
        multipleContainer.className = `template-photo-multiple ${shots}-shots frame-${frameSize}`;
        
        for (let i = 0; i < shots; i++) {
          const photoSlot = document.createElement('div');
          photoSlot.className = `photo-slot effect-${effect}`;
          photoSlot.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
          multipleContainer.appendChild(photoSlot);
        }
        
        photoContainer.appendChild(multipleContainer);
      }

      // Add stickers scattered across the entire card
      if (template.photos && template.photos.length > 1) {
        const stickerOverlay = document.createElement('div');
        stickerOverlay.className = 'sticker-overlay';
        
        // Use saved positions if available, otherwise use default positions
        const defaultPositions = [
          { top: '10%', left: '10%', rotate: '5deg' },
          { top: '15%', left: '80%', rotate: '-10deg' },
          { top: '50%', left: '20%', rotate: '15deg' },
          { top: '60%', left: '70%', rotate: '-5deg' },
          { top: '80%', left: '30%', rotate: '10deg' },
          { top: '85%', left: '85%', rotate: '-15deg' }
        ];
        
        template.photos.slice(1).forEach((sticker, index) => {
          const savedPosition = template.stickerPositions && template.stickerPositions[index];
          const pos = savedPosition ? 
            { top: savedPosition.top, left: savedPosition.left, rotate: '0deg' } : 
            defaultPositions[index % defaultPositions.length];
          
          const stickerDiv = document.createElement('div');
          stickerDiv.className = 'sticker';
          stickerDiv.style.backgroundImage = `url('${sticker}')`;
          stickerDiv.style.top = pos.top;
          stickerDiv.style.left = pos.left;
          stickerDiv.style.transform = `rotate(${pos.rotate})`;
          stickerDiv.setAttribute('data-sticker-index', index);
          stickerOverlay.appendChild(stickerDiv);
        });
        
        article.appendChild(stickerOverlay);
      }

      // Template tags
      const tagsDiv = document.createElement('div');
      tagsDiv.className = 'template-tags';
      tagsDiv.textContent = template.tags || '';

      // Use button
      const useBtn = document.createElement('button');
      useBtn.className = 'vertical-use-template-btn';
      useBtn.setAttribute('aria-label', 'Use this template');
      useBtn.type = 'button';
      useBtn.innerHTML = `<img src="Icons/2.svg" alt="Camera icon" /> Use this template`;
      useBtn.addEventListener('click', () => {
        showToast(`Using favorite template: ${template.name}`, 'success');
      });

      // Icon buttons - FAVORITE (to remove from favorites) and DELETE (for my templates)
      const iconsDiv = document.createElement('div');
      iconsDiv.className = 'vertical-template-icons';
      iconsDiv.setAttribute('role', 'group');
      iconsDiv.setAttribute('aria-label', 'Favorite template controls');

      // Favorite button (to remove from favorites)
      const favoriteBtn = document.createElement('button');
      favoriteBtn.type = 'button';
      favoriteBtn.setAttribute('aria-label', 'Remove from favorites');
      favoriteBtn.setAttribute('title', 'Remove from favorites');
      favoriteBtn.innerHTML = '<img src="Icons 2/save1.svg" alt="Favorite icon" class="favorite-active" />';
      
      favoriteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeFromFavorites(template.id, template.shareToCommunity);
      });

      // Delete button (only for my templates)
      if (!template.shareToCommunity) {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.setAttribute('aria-label', 'Delete template');
        deleteBtn.setAttribute('title', 'Delete template');
        deleteBtn.innerHTML = '<img src="Icons 2/btndel1.svg" alt="Delete icon" />';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('Are you sure you want to delete this template?')) {
            state.myTemplates = state.myTemplates.filter(t => t.id !== template.id);
            renderFavorites();
            renderMyTemplates();
            addActivity(`Template "${template.name}" deleted from My Templates`);
          }
        });
        iconsDiv.appendChild(deleteBtn);
      }

      // Add favorite button to icons container
      iconsDiv.appendChild(favoriteBtn);

      // Assemble the card
      article.appendChild(photoContainer);
      article.appendChild(tagsDiv);
      article.appendChild(useBtn);
      article.appendChild(iconsDiv);

      return article;
    }

    // Remove template from favorites
    function removeFromFavorites(templateId, isShared) {
      if (isShared) {
        const template = sharedTemplates.find(t => t.id === templateId);
        if (template) {
          template.favorite = false;
          addActivity(`Template "${template.name}" removed from favorites`);
        }
      } else {
        const template = state.myTemplates.find(t => t.id === templateId);
        if (template) {
          template.favorite = false;
          addActivity(`Template "${template.name}" removed from favorites`);
        }
      }
      
      renderFavorites();
      renderSharedTemplates();
      renderMyTemplates();
    }

    // Set up drag and drop functionality
    function setupDragAndDrop() {
      const favoriteCards = document.querySelectorAll('#favoritesContainer .vertical-template-card');
      
      favoriteCards.forEach(card => {
        // Drag start event
        card.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', card.dataset.templateId);
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        // Drag end event
        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
          favoritesContainer.classList.remove('drop-zone', 'active');
        });
      });
      
      // Drag over event for the favorites container
      favoritesContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        favoritesContainer.classList.add('drop-zone', 'active');
        e.dataTransfer.dropEffect = 'move';
      });
      
      // Drag leave event for the favorites container
      favoritesContainer.addEventListener('dragleave', (e) => {
        if (!favoritesContainer.contains(e.relatedTarget)) {
          favoritesContainer.classList.remove('drop-zone', 'active');
        }
      });
      
      // Drop event for the favorites container
      favoritesContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        favoritesContainer.classList.remove('drop-zone', 'active');
        
        const templateId = parseInt(e.dataTransfer.getData('text/plain'));
        const templateType = e.dataTransfer.getData('template-type');
        
        // Find the template in the appropriate array
        let template;
        if (templateType === 'shared') {
          template = sharedTemplates.find(t => t.id === templateId);
        } else {
          template = state.myTemplates.find(t => t.id === templateId);
        }
        
        if (template && !template.favorite) {
          template.favorite = true;
          addActivity(`Template "${template.name}" added to favorites`);
          renderFavorites();
          renderSharedTemplates();
          renderMyTemplates();
        }
      });
    }
    // ADMIN DASHBOARD CODE

    // Tab switching - Independent from sidebar
    const subnav = document.querySelector('.subnav');
    
    function showTab(idx) {
      let subnavBtns = document.querySelectorAll('.subnav button');
      let panels = document.querySelectorAll('.tab-panel');
      
      // Hide all sections first
      document.getElementById('section-feed').style.display = 'none';
      document.getElementById('section-favorites').style.display = 'none';
      document.getElementById('section-activity').style.display = 'none';
      
      // Show the subnav when admin tabs are clicked
      subnav.style.display = 'flex';
      
      // Update subnav buttons
      subnavBtns.forEach((btn, i) => {
        btn.classList.toggle('active', i === idx);
        btn.setAttribute('aria-selected', (i === idx).toString());
        panels[i].style.display = i === idx ? 'block' : 'none';
      });
      
      // Reset sidebar to feed (default)
      document.querySelectorAll('.left-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector('[data-target="feed"]').classList.add('active');

      // Tab-specific lazy loads
      if (idx === 0) {
        // Usage stats tab
        renderUsageStats();
      }
      if (idx === 1) {
        // Template Management
        fetchAdminTemplates();
        const s = document.getElementById('templateSearch');
        const sh = document.getElementById('shareFilter');
        const ow = document.getElementById('ownerFilter');
        if (s && !s._wired) { s.addEventListener('input', () => renderTemplateTable(applyTemplateFilters())); s._wired = true; }
        if (sh && !sh._wired) { sh.addEventListener('change', () => renderTemplateTable(applyTemplateFilters())); sh._wired = true; }
        if (ow && !ow._wired) { ow.addEventListener('input', () => renderTemplateTable(applyTemplateFilters())); ow._wired = true; }
      }
      if (idx === 3) {
        // Audit Trail tab
        fetchAllActivityLogs();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      showTab(0);
      // Initialize feed section
      copyFirstTemplateToMyTemplates();
      renderSharedTemplates();
      renderMyTemplates();
      renderFavorites();
      renderActivity();
    });

    // Sidebar navigation - Only redirect to finalprof with target parameter
    const sidebarButtons = document.querySelectorAll('.left-buttons button');

    sidebarButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const target = btn.dataset.target;

        if (target === 'logout') {
          try {
            showToast('Logging out...', 'info');
            // Sign out from Firebase
            if (window.auth && typeof window.auth.signOut === 'function') {
              await window.auth.signOut();
            } else {
              // Fallback: Import and sign out
              const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
              const auth = getAuth();
              await signOut(auth);
            }
            showToast('Logged out successfully', 'success');
            // Redirect to login page
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout error:', error);
            showToast('Logout failed: ' + error.message, 'error');
          }
          return;
        }

        window.location.href = `finalprof.html?target=${target}`;
      });
    });

    // Activity log
    const activityContainer = document.querySelector('.activity-container');
    function addActivity(desc) {
      const now = new Date();
      const timestamp = now.toLocaleString();
      state.activities.unshift({ desc, timestamp });
      if (state.activities.length > 50) state.activities.length = 50;
      renderActivity();
    }

    function renderActivity() {
      activityContainer.innerHTML = '';
      if (state.activities.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'activity-post empty';
        emptyDiv.textContent = 'No activity yet.';
        activityContainer.appendChild(emptyDiv);
        return;
      }
      state.activities.forEach(act => {
        const post = document.createElement('div');
        post.className = 'activity-post';
        post.textContent = `${act.desc}\n${act.timestamp}`;
        activityContainer.appendChild(post);
      });
    }

    // Add some sample activities
    addActivity('Profile picture updated');
    addActivity('Photo 1 added to favorites');
    addActivity('New comment on photo 2');

    // Modal functions (simplified for demo)
    function openModal() {
      document.getElementById('uploadModal').style.display = 'flex';
    }
    
    function closeModal() {
      document.getElementById('uploadModal').style.display = 'none';
    }
    
    function openDeleteModal(templateName) {
      document.getElementById('deleteModal').style.display = 'flex';
      document.getElementById('deleteMessage').textContent = `Are you sure you want to permanently delete "${templateName}"?`;
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }
    
    function confirmDelete() {
      showToast('Template deleted!', 'success');
      closeDeleteModal();
    }

    // Example template data for modals
    const exampleFilterTemplate = {
      name: 'Warm Filter',
      type: 'Filter',
      tags: 'warm, soft, light',
      usageCount: 159,
      status: 'Active',
      dateAdded: '2025-11-10'
    };

    const exampleBackgroundTemplate = {
      name: 'Sunset Background',
      type: 'Background',
      tags: 'sunset, nature, warm',
      usageCount: 42,
      status: 'Active',
      dateAdded: '2025-11-12'
    };

    let CURRENT_VIEWED_TEMPLATE = null;

    function openViewModal(template) {
      CURRENT_VIEWED_TEMPLATE = template || null;
      document.getElementById('viewModal').style.display = 'flex';
      document.getElementById('viewTemplateName').value = template.name;
      const shotsVal = template.shots ? String(template.shots) : '';
      const shotEl = document.getElementById('viewShotCount');
      if (shotEl) shotEl.value = shotsVal;
      document.getElementById('viewType').value = template.type;
      const effEl = document.getElementById('viewEffects');
      if (effEl) effEl.value = template.effect || template.effects || '';
      const img = document.getElementById('viewTemplatePreviewImg');
      if (img) {
        if (template.template_img) {
          img.src = template.template_img;
          img.style.display = 'block';
        } else {
          img.removeAttribute('src');
          img.style.display = 'none';
        }
      }
    }

    function closeViewModal() {
      document.getElementById('viewModal').style.display = 'none';
    }

    function openEditModal(template) {
      document.getElementById('editModal').style.display = 'flex';
      const nameEl = document.getElementById('editTemplateName');
      if (nameEl) nameEl.value = template?.name || '';
      const idEl = document.getElementById('editTemplateId');
      if (idEl) idEl.value = template?.id || template?.template_id || '';
      const shareEl = document.getElementById('editShare');
      if (shareEl) shareEl.value = (template?.share ? 'true' : 'false');
      const effEl = document.getElementById('editEffects');
      if (effEl) {
        let val = (template?.effects || template?.effect || 'none').toString().toLowerCase();
        // normalize a few common aliases
        if (val === 'black & white' || val === 'black_and_white' || val === 'blackandwhite' || val === 'grayscale') val = 'bw';
        // set if exists, otherwise create a temporary option to preserve unknown value
        const hasOption = Array.from(effEl.options).some(o => o.value === val);
        if (!hasOption && val) {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
          effEl.appendChild(opt);
        }
        effEl.value = val || 'none';
      }
      const statusEl = document.getElementById('editStatus');
      if (statusEl) statusEl.value = template?.status || 'Active';
      const ap = document.getElementById('assetPreviewContainer');
      if (ap) {
        if (template?.template_img) {
          ap.innerHTML = '<img class="preview-img" alt="Current asset preview" src="' + template.template_img + '" />';
        } else {
          ap.innerHTML = '<div class="file-status">No preview available</div>';
        }
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function saveChanges() {
      try {
        const id = document.getElementById('editTemplateId')?.value || '';
        const name = document.getElementById('editTemplateName')?.value?.trim() || '';
        const shareVal = document.getElementById('editShare')?.value || 'false';
        const effects = document.getElementById('editEffects')?.value || 'none';
        const status = document.getElementById('editStatus')?.value || 'Active';
        if (!id) { showToast('Missing template id', 'error'); return; }
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'adminUpdateTemplate',
            user_id: ADMIN_USER_ID,
            template_id: id,
            update: {
              name: name,
              share: (shareVal === 'true'),
              effects: effects,
              status: status
            }
          })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Update failed');
        showToast('Template updated', 'success');
        closeEditModal();
        await fetchAdminTemplates();
      } catch (e) {
        console.error('saveChanges error:', e);
        showToast('Failed to save changes', 'error');
      }
    }

    // User management functions
    function switchTab(tabName) {
      // Hide all tab contents
      document.getElementById('accountDetailsContent').style.display = 'none';
      document.getElementById('activityContentsContent').style.display = 'none';
      
      // Show selected tab content
      if (tabName === 'accountDetails') {
        document.getElementById('accountDetailsContent').style.display = 'block';
      } else if (tabName === 'activityContents') {
        document.getElementById('activityContentsContent').style.display = 'block';
      }
      
      // Update tab button styles
      const accountTab = document.getElementById('accountDetailsTab');
      const activityTab = document.getElementById('activityContentsTab');
      
      if (tabName === 'accountDetails') {
        accountTab.style.borderBottom = '3px solid #ea3b91';
        accountTab.style.color = '#ea3b91';
        activityTab.style.borderBottom = '3px solid transparent';
        activityTab.style.color = '#d23481';
      } else {
        accountTab.style.borderBottom = '3px solid transparent';
        accountTab.style.color = '#d23481';
        activityTab.style.borderBottom = '3px solid #ea3b91';
        activityTab.style.color = '#ea3b91';
      }
    }

    function closeManageUserModal() {
      document.getElementById('manageUserModal').style.display = 'none';
    }

    function saveChangesUser() {
      alert('User changes saved!');
      closeManageUserModal();
    }

    function closeDeleteUserModal() {
      document.getElementById('deleteUserModal').style.display = 'none';
    }

    function confirmDeleteUser() {
      alert('User deleted!');
      closeDeleteUserModal();
    }

    // Add event listeners for manage links
    document.querySelectorAll('.manage-link').forEach(link => {
      link.addEventListener('click', function() {
        document.getElementById('manageUserModal').style.display = 'flex';
      });
    });

    // Add event listener for delete user button
    document.getElementById('deleteUserBtn').addEventListener('click', function() {
      document.getElementById('deleteUserModal').style.display = 'flex';
    });

const API_ENDPOINT = 'http://localhost/public/pdo/api.php'; // IMPORTANT: Replace with your actual PHP API URL

// Initialize Firebase
(async () => {
  try {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js');
    const firebaseConfig = {
      apiKey: "AIzaSyBbSE2lqLfQCZU4L4a0hNfpM1ud11I854w",
      authDomain: "photobooth-c42a9.firebaseapp.com",
      projectId: "photobooth-c42a9",
      storageBucket: "photobooth-c42a9.firebasestorage.app",
      messagingSenderId: "994496567051",
      appId: "1:994496567051:web:81d507ace1fbd2db77b40e",
      measurementId: "G-4FHWWBR2BJ"
    };
    const app = initializeApp(firebaseConfig);
    const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
    window.auth = getAuth(app);
    
    // Check if user is admin
    onAuthStateChanged(window.auth, async (user) => {
      if (!user) {
        // User not logged in, redirect to login
        window.location.href = 'login.html';
        return;
      }
      
      // Check if user has admin role
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'fetchOrCreateProfile', 
            user_id: user.uid,
            email: user.email,
            display_name: user.displayName
          })
        });
        const result = await response.json();
        
        console.log('Admin check response:', result);
        console.log('User UID:', user.uid);
        console.log('User admin status:', result.data?.admin);
        
        if (!result.success || !result.data?.admin) {
          // User is not an admin, redirect to finalprof
          console.log('User is not admin. Admin value:', result.data?.admin);
          window.location.href = 'finalprof.html';
        } else {
          console.log('User is admin, access granted');
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        // On error, redirect to finalprof for safety
        window.location.href = 'finalprof.html';
      }
    });
  } catch (error) {
    console.error('Firebase initialization error:', error);
  }
})();

// Toast notification helper - matching finalprof.html style
const showToast = (message, type = 'success', duration = 3000) => {
    const container = (() => {
        let div = document.getElementById('notification-container');
        if (!div) {
            div = document.createElement('div');
            div.id = 'notification-container';
            document.body.appendChild(div);
        }
        return div;
    })();
    
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    if (duration > 0) {
        setTimeout(() => {
            toast.classList.add('removing');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
    
    return toast;
};

// =========================
// Template Management (Admin)
// =========================
const ADMIN_USER_ID = 'admin_placeholder_id';
let adminTemplatesCache = [];

async function fetchAdminTemplates() {
  try {
    const res = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'adminFetchAllTemplates', user_id: ADMIN_USER_ID })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'Failed to load templates');
    adminTemplatesCache = json.data || [];
    renderTemplateTable(applyTemplateFilters());
  } catch (e) {
    console.error('fetchAdminTemplates error:', e);
    showToast('Failed to load templates', 'error');
  }
}

function applyTemplateFilters() {
  const search = document.getElementById('templateSearch')?.value?.toLowerCase() || '';
  const shareFilter = document.getElementById('shareFilter')?.value || '';
  const ownerFilter = document.getElementById('ownerFilter')?.value?.toLowerCase() || '';

  let filtered = [...adminTemplatesCache];
  if (search) {
    filtered = filtered.filter(t => (t.name || '').toLowerCase().includes(search));
  }
  if (ownerFilter) {
    filtered = filtered.filter(t => (t.owner_name || '').toLowerCase().includes(ownerFilter));
  }
  if (shareFilter) {
    if (shareFilter === 'shared') filtered = filtered.filter(t => !!t.share);
    if (shareFilter === 'private') filtered = filtered.filter(t => !t.share);
  }
  return filtered;
}

function renderTemplateTable(templates) {
  const tbody = document.getElementById('templateTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (!templates.length) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 7;
    td.textContent = 'No templates found';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  templates.forEach(t => {
    const tr = document.createElement('tr');
    const created = t.created_at ? new Date(t.created_at).toLocaleString() : '';
    const sharedLabel = t.share ? 'Yes' : 'No';
    tr.innerHTML = `
      <td>${t.name || '(unnamed)'}</td>
      <td>${t.owner_name || t.user_id || ''}</td>
      <td>${t.frame_size || ''}</td>
      <td>${t.shot_count || ''}</td>
      <td>${sharedLabel}</td>
      <td>${created}</td>
      <td style="white-space:nowrap;">
        <button title="View" aria-label="View" onclick='viewTemplateDetails(${JSON.stringify({id:t.template_id,name:t.name,frame:t.frame_size,shots:t.shot_count,img:t.template_img,effects:t.effects,share:!!t.share}).replace(/'/g,"&#39;")})'>
          <img src="Icons 3/view.svg" alt="View" />
        </button>
        <button title="Edit Details" aria-label="Edit Details" onclick='openEditModal(${JSON.stringify({id: ""}).replace("{\"id\":\"\"}", JSON.stringify({
            id: t.template_id,
            name: t.name,
            frame: t.frame_size,
            shots: t.shot_count,
            effects: t.effects,
            share: !!t.share,
            status: t.status || "Active",
            template_img: t.template_img
          })).replace(/'/g, "&#39;")})'>
          <img src="Icons 2/edit.svg" alt="Edit" />
        </button>
        <button title="Delete" aria-label="Delete" onclick="adminDeleteTemplate('` + t.template_id + `')">
          <img src="Icons 3/delete.svg" alt="Delete" />
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function viewTemplateDetails(info) {
  // Re-use existing view modal if present
  try {
    if (typeof CURRENT_VIEWED_TEMPLATE !== 'undefined') {
      CURRENT_VIEWED_TEMPLATE = {
        ...info,
        template_img: info.img || info.template_img || null,
        share: typeof info.share === 'boolean' ? info.share : !!info.share,
      };
    }
    document.getElementById('viewModal').style.display = 'flex';
    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };
    setVal('viewTemplateName', info.name || '');
    setVal('viewType', info.frame || '');
    setVal('viewShotCount', info.shots ? String(info.shots) : '');
    setVal('viewEffects', info.effects || '');
    const img = document.getElementById('viewTemplatePreviewImg');
    if (img) {
      if (info.img) {
        img.src = info.img;
        img.style.display = 'block';
      } else {
        img.removeAttribute('src');
        img.style.display = 'none';
      }
    }
  } catch (e) {
    console.warn('View modal not configured, showing toast only');
    showToast(info.name ? info.name : 'Template', 'info');
  }
}

async function toggleTemplateShare(templateId, currentShare) {
  try {
    const res = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'adminUpdateTemplate',
        user_id: ADMIN_USER_ID,
        template_id: templateId,
        update: { share: !currentShare }
      })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'Update failed');
    showToast('Template updated', 'success');
    await fetchAdminTemplates();
  } catch (e) {
    console.error('toggleTemplateShare error:', e);
    showToast('Failed to update template', 'error');
  }
}

async function adminDeleteTemplate(templateId) {
  try {
    const res = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'adminDeleteTemplate', user_id: ADMIN_USER_ID, template_id: templateId })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'Delete failed');
    showToast('Template deleted', 'success');
    await fetchAdminTemplates();
  } catch (e) {
    // Upload helpers similar to finalprof save flow
    function updateUploadFields() {
      const type = document.getElementById('templateType').value;
      const dual = document.getElementById('dualUploadContainer');
      const single = document.getElementById('singleUploadContainer');
      const instr = document.getElementById('uploadInstruction');
      if (type === 'Sticker Pack') {
        dual.style.display = 'block';
        single.style.display = 'none';
      } else {
        dual.style.display = 'none';
        single.style.display = 'block';
        instr.textContent = type === 'Filter' ? 'Upload Filter Config (.json)' : 'Upload Single PNG asset';
        const singleUpload = document.getElementById('singleUpload');
        singleUpload.accept = type === 'Filter' ? '.json' : '.png';
      }
    }

    function generateTemplateId() {
      const rand = Math.random().toString(36).slice(2, 8);
      return 'tpl_' + Date.now() + '_' + rand;
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function submitForm() {
      const name = document.getElementById('templateName').value.trim();
      const type = document.getElementById('templateType').value;
      const tags = document.getElementById('tags').value.trim();
      const frame_size = document.getElementById('frameSize').value;
      const shot_count = document.getElementById('shotCount').value;
      const effect = document.getElementById('effectSelect').value;
      const status = (document.querySelector('input[name="status"]:checked')?.value || 'Draft');
      const share = document.getElementById('shareCheckbox').checked || status === 'Active';

      let template_img = null;
      let effects = effect; // keep simple string like finalprof presets
      let sticker = null;
      let text = [];
      let background = '#ffffff';
      let font = 'Inter';
      let show_logo = false, show_date = false, show_time = false;

      try {
        if (type === 'Sticker Pack') {
          const f2 = document.getElementById('upload2x6').files[0];
          if (!f2) return showToast('Please select 2x6 PNG', 'error');
          template_img = await readFileAsDataUrl(f2);
        } else {
          const f = document.getElementById('singleUpload').files[0];
          if (!f) return showToast('Please select a file to upload', 'error');
          if (type === 'Filter') {
            // For filter config, just keep the effects name and ignore JSON detailed parsing for now
            if (!f.name.endsWith('.json')) return showToast('Please upload a .json config for Filter', 'error');
            // Optionally parse to validate
            const txt = await f.text();
            try { JSON.parse(txt); } catch { /* ignore */ }
          } else {
            // Background - use PNG preview as template_img
            if (!f.type.includes('png')) return showToast('Please upload a PNG for Background', 'error');
            template_img = await readFileAsDataUrl(f);
          }
        }

        const template_id = generateTemplateId();
        const payload = {
          action: 'saveTemplateState',
          user_id: 'admin_placeholder_id',
          template_id,
          template_state: {
            name,
            frame_size,
            shot_count,
            effects,
            sticker,
            text,
            font,
            text_color: '#000000',
            background,
            show_logo,
            show_date,
            show_time,
            share,
            template_img
          }
        };

        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Upload failed');

        showToast('Template uploaded', 'success');
        closeModal();
        // refresh admin templates table
        if (typeof fetchAdminTemplates === 'function') fetchAdminTemplates();
      } catch (e) {
        console.error('submitForm error:', e);
        showToast('Failed to upload template', 'error');
      }
    }
    console.error('adminDeleteTemplate error:', e);
    showToast('Failed to delete template', 'error');
  }
}

    // Helper function to update the stat cards (explicit growth id to avoid mismatches)
    function updateStatCard(numberId, growthId, value, growth, isPercentage = false) {
      const numberElement = document.getElementById(numberId);
      const growthElement = document.getElementById(growthId);
        
        numberElement.textContent = value.toLocaleString();

        const growthAbs = Math.abs(growth);
        const iconClass = growth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        const colorStyle = growth >= 0 ? 'color:#7fc97f;' : 'color:#d32f2f;';
        const growthText = `${isPercentage ? growthAbs + '%' : growthAbs} this week`;

        growthElement.innerHTML = `<i class="percentage fa ${iconClass}"></i> ${growthText}`;
        growthElement.style.cssText = colorStyle;
        growthElement.classList.toggle('negative-growth', growth < 0);
    }

    async function renderUsageStats() {
        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'fetchUsageStats', user_id: 'admin_placeholder_id' }) // user_id is optional here, but good practice
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();

            if (!result.success) throw new Error(result.error || 'Failed to fetch usage stats.');

            const data = result.data;

            // 1. Update Stat Cards
            updateStatCard('total-users', 'user-growth', data.total_users, data.user_growth_percentage, true);
            updateStatCard('photos-captured', 'photo-growth', data.total_photos, data.photo_growth_percentage, true);

            // 2. Render User Growth Line Chart (Daily Signups)
            if (data.daily_user_signups && data.daily_user_signups.length > 0) {
                const lineChartSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                    "width": "container",
                    "height": 180,
                    "data": { "values": data.daily_user_signups },
                    "mark": { "type": "line", "point": true, "color": "#ea3b91" },
                    "encoding": {
                        "x": { 
                            "field": "date", 
                            "type": "temporal", 
                            "title": "Date",
                            "axis": { "format": "%b %d", "grid": false }
                        },
                        "y": { 
                            "field": "count", 
                            "type": "quantitative", 
                            "title": "New Users",
                            "axis": { "grid": true, "tickCount": 5 }
                        },
                        "tooltip": [
                            { "field": "date", "type": "temporal", "title": "Date", "format": "%Y-%m-%d" },
                            { "field": "count", "type": "quantitative", "title": "New Users" }
                        ]
                    },
                    "config": {
                        "view": { "stroke": "transparent" },
                        "axis": { "labelColor": "#d23481", "titleColor": "#d23481" }
                    }
                };
                
                vegaEmbed('#user-growth-chart', lineChartSpec, { actions: false });
            } else {
                document.getElementById('user-growth-chart').textContent = "No user data available for the last 30 days.";
            }


              // 4. Render User Status Distribution Pie Chart
              if (data.status_distribution && data.status_distribution.length > 0) {
                const statusChartSpec = {
                  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                  "width": 300,
                  "height": 300,
                  "data": { "values": data.status_distribution },
                  "mark": { "type": "arc", "tooltip": true },
                  "encoding": {
                    "theta": { "field": "count", "type": "quantitative" },
                    "color": { "field": "status", "type": "nominal", "scale": { "scheme": "set2" } },
                    "tooltip": [
                      { "field": "status", "type": "nominal", "title": "Status" },
                      { "field": "count", "type": "quantitative", "title": "Count" }
                    ]
                  },
                  "config": {
                    "view": { "stroke": "transparent" }
                  }
                };
                vegaEmbed('#status-distribution-chart', statusChartSpec, { actions: false });
              } else {
                document.getElementById('status-distribution-chart').textContent = "No status data available.";
              }

              // 5. Render Top Favorited Templates as text summary (Top 3)
              // Build robust top favorites: handle both aggregated and raw rows
              let topFavs = [];
              const aggregated = Array.isArray(data.top_favorited_templates) ? data.top_favorited_templates : [];
              const rawRows = Array.isArray(data.favorite_template) ? data.favorite_template : [];

              if (aggregated.length > 0) {
                topFavs = aggregated.map(t => ({
                  template: (t.title ?? t.template ?? t.name ?? 'Unknown'),
                  favorites: Number(t.favorite_count ?? t.favorites ?? t.count ?? 0) || 0
                }));
              } else if (rawRows.length > 0) {
                // Compute frequency by title from raw favorite_template rows
                const freq = {};
                rawRows.forEach(r => {
                  const key = (r.title ?? r.template ?? r.name ?? 'Unknown');
                  freq[key] = (freq[key] || 0) + 1;
                });
                topFavs = Object.entries(freq).map(([template, favorites]) => ({ template, favorites }));
              }

              topFavs = topFavs
                .filter(d => d.favorites > 0)
                .sort((a, b) => b.favorites - a.favorites)
                .slice(0, 3);

              const favContainer = document.getElementById('top-favorites-summary');
              if (favContainer) {
                if (topFavs.length > 0) {
                  const list = document.createElement('ol');
                  list.style.margin = '0';
                  list.style.paddingLeft = '1.2rem';
                  topFavs.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.template}  ${item.favorites} favorites`;
                    list.appendChild(li);
                  });
                  favContainer.innerHTML = '';
                  favContainer.appendChild(list);
                } else {
                  favContainer.textContent = 'No favorites data available.';
                }
              }

            } catch (error) {
            console.error('Error rendering usage stats:', error);
            const ug = document.getElementById('user-growth-summary');
            if (ug) ug.textContent = `Error loading data: ${error.message}`;
            const sd = document.getElementById('status-distribution-chart');
            if (sd) sd.textContent = `Error loading data: ${error.message}`;
            const tf = document.getElementById('top-favorites-summary');
            if (tf) tf.textContent = `Error loading data: ${error.message}`;
        }
    }

    // =========================
    // User Management Functions
    // =========================
    async function fetchUsers({ search = '', role = '', admin_only = '' } = {}) {
      try {
        const payload = { action: 'fetchUsers' };
        if (search) payload.search = search;
        if (role) payload.role = role;
        if (admin_only !== '') {
          payload.admin_only = admin_only === 'true';
        }

        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Failed to fetch users');
        return json.data;
      } catch (err) {
        console.error('fetchUsers error:', err);
        return [];
      }
    }

    function renderUsersTable(users) {
      const tbody = document.querySelector('.user-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!users.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = 'No users found';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      users.forEach(u => {
        const tr = document.createElement('tr');
        // Use the status field from database
        const displayStatus = u.status ? u.status.charAt(0).toUpperCase() + u.status.slice(1) : 'Active';
        // Use admin field to determine role display
        const displayRole = u.admin ? 'Admin' : 'User';
        tr.innerHTML = `
          <td>${u.username ?? ''}</td>
          <td>${u.email ?? ''}</td>
          <td>${displayRole}</td>
          <td>${displayStatus}</td>
          <td>
            <button class="manage-link" data-user-id="${u.user_id}">Manage</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Wire manage/delete actions
      tbody.querySelectorAll('.manage-link').forEach(btn => {
        btn.addEventListener('click', async () => {
          const userId = btn.getAttribute('data-user-id');
          const user = users.find(x => x.user_id === userId);
          if (!user) return;
          // Populate manage modal fields
          document.getElementById('manageUserModal').style.display = 'flex';
          document.getElementById('accountDetailsContent').style.display = 'block';
          document.getElementById('activityContentsContent').style.display = 'none';
          
          // Reset tab styles
          const accountTab = document.getElementById('accountDetailsTab');
          const activityTab = document.getElementById('activityContentsTab');
          accountTab.style.borderBottom = '3px solid #ea3b91';
          accountTab.style.color = '#ea3b91';
          activityTab.style.borderBottom = '3px solid transparent';
          activityTab.style.color = '#d23481';

          // Assuming inputs exist with these IDs in the manage modal (adjust if different)
          const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };
          setVal('manageUserId', user.user_id);
          setVal('manageUsername', user.username);
          setVal('manageEmail', user.email);
          // Set role based on admin field: if admin is true  "Admin", else  "User"
          setVal('manageRole', user.admin ? 'Admin' : 'User');
          setVal('manageBio', user.bio ?? '');
          // Set status based on status field: capitalize the first letter
          const statusValue = user.status ? user.status.charAt(0).toUpperCase() + user.status.slice(1) : 'Active';
          setVal('manageStatus', statusValue);
          const adminCheckbox = document.getElementById('manageAdmin');
          if (adminCheckbox) adminCheckbox.checked = !!user.admin;
          
          // Fetch and display photo count and activity logs
          await fetchAndDisplayUserStats(user.user_id, user.created_at);
          await fetchAndDisplayActivityLogs(user.user_id);
        });
      });
    }
    
    // Fetch user photo count and display statistics
    async function fetchAndDisplayUserStats(userId, createdAt) {
      try {
        // Format the joined date
        const joinedDate = new Date(createdAt).toLocaleDateString();
        document.getElementById('manageJoined').value = joinedDate;
        
        // Fetch photo count
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'fetchUserPhotoCount', target_user_id: userId })
        });
        const json = await res.json();
        if (json.success) {
          document.getElementById('manageTotalPhotos').value = json.data.photo_count || 0;
        }
      } catch (err) {
        console.error('Error fetching user stats:', err);
        document.getElementById('manageTotalPhotos').value = '0';
      }
    }
    
    // Fetch and display user activity logs
    async function fetchAndDisplayActivityLogs(userId) {
      try {
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'fetchActivityLog', target_user_id: userId })
        });
        const json = await res.json();
        const activityList = document.getElementById('manageUserActivityList');
        
        if (json.success && json.data && json.data.length > 0) {
          activityList.innerHTML = '';
          json.data.forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.style.cssText = 'padding: 0.8rem; background: #fff; border: 1px solid #f4c1d9; border-radius: 6px; font-size: 0.95rem;';
            const timestamp = new Date(activity.created_at).toLocaleString();
            activityItem.innerHTML = `
              <div style="font-weight: 600; margin-bottom: 0.3rem;">${activity.action}</div>
              <div style="font-size: 0.85rem; color: #999;">${timestamp}</div>
            `;
            activityList.appendChild(activityItem);
          });
        } else {
          activityList.innerHTML = '<p style="color: #999; font-style: italic;">No activity logs found.</p>';
        }
      } catch (err) {
        console.error('Error fetching activity logs:', err);
        document.getElementById('manageUserActivityList').innerHTML = '<p style="color: #d32f2f;">Failed to load activity logs.</p>';
      }
    }

    async function refreshUsersFromFilters() {
      const search = document.getElementById('userSearchInput')?.value || '';
      const role = document.getElementById('userGroupFilter')?.value || '';
      
      // Convert role filter to admin_only parameter
      let admin_only = '';
      if (role && role !== 'All groups') {
        admin_only = role === 'Admin' ? 'true' : 'false';
      }
      
      const users = await fetchUsers({ search, admin_only });
      renderUsersTable(users);
    }

    // Save changes from manage modal
    async function saveChangesUser() {
      const target_user_id = document.getElementById('manageUserId')?.value;
      if (!target_user_id) return showToast('Missing user id', 'error');
      
      const roleValue = document.getElementById('manageRole')?.value;
      const statusValue = document.getElementById('manageStatus')?.value;
      
      // Ensure admin is always a boolean: Admin = true, User = false
      const isAdmin = roleValue === 'Admin';
      
      const update = {
        admin: isAdmin,
        status: statusValue ? statusValue.toLowerCase() : 'active'
      };
      
      // Only include username/email if they have actual values
      const username = document.getElementById('manageUsername')?.value;
      const email = document.getElementById('manageEmail')?.value;
      if (username && username.trim()) update.username = username;
      if (email && email.trim()) update.email = email;
      
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'updateUser', target_user_id, update })
      });
      const json = await res.json();
      if (!json.success) return showToast(json.error || 'Failed to update user', 'error');
      showToast('User changes saved!', 'success');
      document.getElementById('manageUserModal').style.display = 'none';
      refreshUsersFromFilters();
    }

    // Confirm delete user
    async function confirmDeleteUser() {
      const modal = document.getElementById('deleteUserModal');
      const target_user_id = modal?.getAttribute('data-target-user-id');
      if (!target_user_id) return showToast('Missing user id', 'error');
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'deleteUser', target_user_id })
      });
      const json = await res.json();
      if (!json.success) return showToast(json.error || 'Failed to delete user', 'error');
      showToast('User deleted!', 'success');
      modal.style.display = 'none';
      refreshUsersFromFilters();
    }

    // Wire filters
    document.addEventListener('DOMContentLoaded', () => {
      // Initial load
      refreshUsersFromFilters();

      const searchInput = document.getElementById('userSearchInput');
      const roleSelect = document.getElementById('userGroupFilter');
      const statusSelect = document.getElementById('userStatusFilter');
      if (searchInput) searchInput.addEventListener('input', () => refreshUsersFromFilters());
      if (roleSelect) roleSelect.addEventListener('change', () => refreshUsersFromFilters());
      if (statusSelect) statusSelect.addEventListener('change', () => refreshUsersFromFilters());
    });
    // Call the function when the Usage Stats tab is active
    document.addEventListener('DOMContentLoaded', () => {
        // Initial load for the first tab
        renderUsageStats(); 
    });

    // =========================
    // Audit Trail Functions
    // =========================
    let allAuditLogs = [];
    let userIdToNameMap = {}; // Map user_id to username
    
    async function buildUserIdToNameMap() {
      try {
        const users = await fetchUsers({});
        userIdToNameMap = {};
        users.forEach(u => {
          if (u.user_id && u.username) {
            userIdToNameMap[u.user_id] = u.username;
          }
        });
      } catch (err) {
        console.error('Error building user map:', err);
      }
    }
    
    function categorizeAction(action) {
      if (!action) return 'Other';
      const a = action.toLowerCase();
      if (a.includes('login')) return 'Login';
      if (a.includes('deleted') || a.includes('delet')) return 'Deletion';
      if (a.includes('upload')) return 'Content Upload';
      if (a.includes('configuration') || a.includes('settings') || a.includes('config')) return 'Configuration Change';
      if (a.includes('error') || a.includes('failed')) return 'System Error';
      if (a.includes('profile')) return 'Profile';
      if (a.includes('comment')) return 'Comments';
      if (a.includes('liked') || a.includes('unliked')) return 'Likes';
      if (a.includes('favorite')) return 'Favorites';
      if (a.includes('template')) return 'Templates';
      if (a.includes('photo')) return 'Photos';
      return 'Other';
    }
    
    async function fetchAllActivityLogs() {
      try {
        // First, build the user ID to name mapping
        await buildUserIdToNameMap();
        
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'fetchActivityLog' })
        });
        const json = await res.json();
        if (json.success && json.data) {
          // enrich with category
          allAuditLogs = json.data.map(log => ({
            ...log,
            category: categorizeAction(log.action)
          }));
          populateActionTypeFilter();
          refreshAuditTrail();
        } else {
          console.error('Failed to fetch activity logs:', json.error);
        }
      } catch (err) {
        console.error('Error fetching activity logs:', err);
      }
    }
    
    function populateActionTypeFilter() {
      const filterSelect = document.getElementById('auditActionTypeFilter');
      if (!filterSelect) return;
      
      // Clear existing (keep first default option)
      filterSelect.innerHTML = '';
      const allOpt = document.createElement('option');
      allOpt.value = '';
      allOpt.textContent = 'All categories';
      filterSelect.appendChild(allOpt);

      // Get unique categories from logs
      const categories = Array.from(new Set(allAuditLogs.map(l => l.category))).sort();
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        filterSelect.appendChild(option);
      });
    }
    
    function renderAuditTrailTable(logs) {
      const tbody = document.getElementById('auditTrailTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!logs.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'No audit logs found';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      // Group by category
      const grouped = logs.reduce((acc, log) => {
        const cat = log.category || 'Other';
        (acc[cat] = acc[cat] || []).push(log);
        return acc;
      }, {});

      // Render groups in alphabetical order
      Object.keys(grouped).sort().forEach(cat => {
        // Group header row
        const headerTr = document.createElement('tr');
        const headerTd = document.createElement('td');
        headerTd.colSpan = 3;
        headerTd.style.cssText = 'font-weight:700;background:#fff4f8;border-top:2px solid #f4c1d9;color:#c32d6c;';
        headerTd.textContent = cat;
        headerTr.appendChild(headerTd);
        tbody.appendChild(headerTr);

        // Entries under this category
        grouped[cat].forEach(log => {
          const tr = document.createElement('tr');
          const timestamp = new Date(log.created_at).toLocaleString();
          // Try to get username from map first, then fall back to various name fields, then user_id, then 'System'
          const displayName = userIdToNameMap[log.user_id] || 
                             log.user_name || 
                             log.username || 
                             log.name || 
                             (log.user_id && log.user_id !== 'System' ? `User ${log.user_id}` : 'System');
          tr.innerHTML = `
            <td>${timestamp}</td>
            <td>${displayName}</td>
            <td>${log.action ?? ''}</td>
          `;
          tbody.appendChild(tr);
        });
      });
    }
    
    function refreshAuditTrail() {
      const searchInput = document.getElementById('auditSearchInput')?.value || '';
      const actionFilter = document.getElementById('auditActionTypeFilter')?.value || '';
      
      let filtered = allAuditLogs;
      
      // Filter by search term (username or action)
      if (searchInput) {
        const searchLower = searchInput.toLowerCase();
        filtered = filtered.filter(log => {
          // Check the mapped username first, then fall back to other fields
          const displayName = userIdToNameMap[log.user_id] || 
                             log.user_name || 
                             log.username || 
                             log.name || 
                             log.user_id || 
                             '';
          return (
            (displayName && String(displayName).toLowerCase().includes(searchLower)) ||
            (log.action && log.action.toLowerCase().includes(searchLower))
          );
        });
      }
      
      // Filter by category
      if (actionFilter) {
        filtered = filtered.filter(log => log.category === actionFilter);
      }
      
      renderAuditTrailTable(filtered);
    }
    
    // Wire up audit trail filters
    document.addEventListener('DOMContentLoaded', () => {
      fetchAllActivityLogs();
      
      const auditSearchInput = document.getElementById('auditSearchInput');
      const auditActionFilter = document.getElementById('auditActionTypeFilter');
      
      if (auditSearchInput) auditSearchInput.addEventListener('input', () => refreshAuditTrail());
      if (auditActionFilter) auditActionFilter.addEventListener('change', () => refreshAuditTrail());
    });

  </script>
</body>
</html>