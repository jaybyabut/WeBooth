<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Your Photo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="customizationphoto-style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Fredoka+One&family=Poppins&family=Montserrat&family=Roboto&family=Open+Sans&family=Lora&family=Raleway&family=Playfair+Display&family=Nunito&family=Merriweather&family=Quicksand&family=Ubuntu&family=Oswald&family=DM+Sans&family=Cabin&family=Lobster&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // 2. FIREBASE CONFIG AND INITIALIZATION
        const firebaseConfig = {
            apiKey: "AIzaSyBbSE2lqLfQCZU4L4a0hNfpM1ud11I854w",
            authDomain: "photobooth-c42a9.firebaseapp.com",
            projectId: "photobooth-c42a9",
            storageBucket: "photobooth-c42a9.firebasestorage.app",
            messagingSenderId: "994496567051",
            appId: "1:994496567051:web:81d507ace1fbd2db77b40e",
            measurementId: "G-4FHWWBR2BJ"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Define a global variable to store the current user's UID
        window.currentUserId = null;

        // AUTH CHECK - RUNS INSIDE MODULE SCOPE
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUserId = user.uid;
            } else {
                window.currentUserId = null;
            }
        });

        // 3. REAL FIREBASE STORAGE UPLOAD FUNCTIONS
        
        // Template Upload Function (for saving templates)
        window.uploadTemplateImage = async (imageBlob, userId) => {
            if (!userId) {
                throw new Error("User ID is required for image upload.");
            }
            const filename = `template-${Date.now()}.png`;
            const storageRef = ref(storage, `template/${userId}/${filename}`); 
            console.log(`Uploading template image to Firebase Storage: template/${userId}/${filename}`);
            await uploadBytes(storageRef, imageBlob, { contentType: 'image/png' });
            const downloadURL = await getDownloadURL(storageRef);
            return downloadURL;
        };
        
        // Post Image Upload Function (for posting the final photo strip)
        window.uploadPostImage = async (imageBlob, userId) => {
            if (!userId) {
                throw new Error("User ID is required for image upload.");
            }
            const filename = `post-${Date.now()}.png`;
            // Store in a different directory than templates
            const storageRef = ref(storage, `posts/${userId}/${filename}`); 
            console.log(`Uploading post image to Firebase Storage: posts/${userId}/${filename}`);
            await uploadBytes(storageRef, imageBlob, { contentType: 'image/png' });
            const downloadURL = await getDownloadURL(storageRef);
            return downloadURL;
        };


        // --- GLOBAL FILTER HELPERS (Required for Download button logic) ---
        window.getCanvasFilterString = (filterClass) => {
            switch (filterClass) {
                case 'filter-bw': return 'grayscale(100%)';
                case 'filter-warm': return 'sepia(70%)'; 
                case 'filter-cool': return 'contrast(1.1) brightness(1.1) saturate(1.3) hue-rotate(-15deg)';
                case 'filter-retro': return 'sepia(100%) brightness(0.9) contrast(1.1)';
                case 'filter-noir': return 'grayscale(100%) contrast(1.2) brightness(0.8)';
                case 'filter-none':
                default: return 'none';
            }
        };
        window.applyFilterToCanvas = (imageDataUrl, filterClass, callback) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.filter = window.getCanvasFilterString(filterClass);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/png'));
            };
            img.src = imageDataUrl;
            img.crossOrigin = 'Anonymous'; 
        };
        
        // Pass the window.currentUserId check function outside the module
        window.checkAuthAndGetUid = () => {
            if (!window.currentUserId) {
                alert("Authentication failed. Please log in.");
                return null;
            }
            return window.currentUserId;
        };


        // --- APPLICATION LOGIC MOVED INTO MODULE SCOPE ---
        document.addEventListener('DOMContentLoaded', () => {
        
            const saveBtn = document.getElementById('save-btn');
            const photostripElement = document.getElementById('photostrip-preview');
            const textOverlayLayer = document.getElementById('text-overlay-layer'); 
            const fontSelect = document.getElementById('font-select');
            const textColorPicker = document.getElementById('text-color');
            const logoCheckbox = document.getElementById('logo-checkbox');
            const dateCheckbox = document.getElementById('date-checkbox');
            const timeCheckbox = document.getElementById('time-checkbox');

            // Initial settings from localStorage
            const frameSize = localStorage.getItem('frameSize') || '2x6';
            const activeFilter = localStorage.getItem('activeFilter') || 'filter-none';
            
            let capturedImages = [];
            try {
                const imagesJson = sessionStorage.getItem('capturedImagesArray');
                if (imagesJson) {
                    capturedImages = JSON.parse(imagesJson);
                }
            } catch (e) {
                console.error("Error parsing captured images array:", e);
            }
            
            const storedShotCount = parseInt(localStorage.getItem('numShots'));
            const shotCount = capturedImages.length > 0 ? capturedImages.length : (storedShotCount || 3);
            
            const photoStrip = document.getElementById('photostrip-preview');
            const templateFooter = photoStrip.querySelector('.template-footer');
            const stickerOverlay = document.getElementById('sticker-overlay'); 
            
            // --- Helper to Create Image Element with Filter ---
            const createStripImage = (imageDataUrl, filterClass) => {
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.classList.add('w-full', 'h-full', 'object-cover', filterClass); 
                return img;
            };
            
            // --- 2. Apply Frame Size & Layout ---
            
            let shotAspectRatio = '4/3'; 
            
            if (frameSize === '2x6') {
                photoStrip.classList.remove('layout-4x6');
                shotAspectRatio = '4/3'; 
                photoStrip.classList.remove('layout-grid-2x2');
            } else if (frameSize === '4x6') {
                photoStrip.classList.add('layout-4x6');
                
                if (shotCount === 4) {
                    photoStrip.classList.add('layout-grid-2x2', 'layout-4shots');
                    shotAspectRatio = '4/3'; 
                } else {
                    photoStrip.classList.remove('layout-grid-2x2', 'layout-4shots');
                    shotAspectRatio = '3/2'; 
                }
            }
            
            // --- CRITICAL STICKER PATH FIX (Run first to update buttons/preview based on frame size) ---
            const updateStickerPaths = (targetFrameSize) => {
                const stickerPathReplace = targetFrameSize === '4x6' ? '4x6' : '2x6';
                const imagePathSegment = targetFrameSize === '4x6' ? '4 x 6 in' : '2 x 6 in';
                
                document.querySelectorAll('.sticker-button img').forEach(img => {
                    const basePath = img.dataset.baseSrc;
                    if (basePath) {
                        // Update the visible image source in the button grid
                        img.src = basePath.replace('(X in)', `(${imagePathSegment})`).replace(/X/g, stickerPathReplace);
                    }
                });
                return { stickerPathReplace, imagePathSegment };
            };
            
            // Update all sticker preview images
            const { stickerPathReplace, imagePathSegment } = updateStickerPaths(frameSize);

            // --- Initial Sticker Load based on Frame Size ---
            const storedStickerBase = localStorage.getItem('activeStickerBase');
            if (storedStickerBase && stickerOverlay) {
                
                const initialStickerSrc = storedStickerBase
                    .replace('(X in)', `(${imagePathSegment})`)
                    .replace(/X/g, stickerTag);

                stickerOverlay.src = initialStickerSrc;
                stickerOverlay.style.display = 'block';
            }
            // ------------------------------------------------


            // --- 3. Apply Number of Shots (Dynamic Loop) ---
            
            // Remove existing shots before re-rendering (must leave sticker and text layers)
            photoStrip.querySelectorAll('.photo-strip-image').forEach(photo => photo.remove());

            // Find the index of the first non-image element (like sticker layer or footer) to insert before
            const firstNonImageIndex = Array.from(photoStrip.children).findIndex(el => 
                el.id === 'sticker-overlay' || el.id === 'text-overlay-layer' || el.classList.contains('template-footer')
            );
            const insertBeforeElement = firstNonImageIndex !== -1 ? photoStrip.children[firstNonImageIndex] : templateFooter;

            for (let i = 0; i < shotCount; i++) {
                const photoDiv = document.createElement('div');
                photoDiv.classList.add('photo-strip-image');
                
                // Set the calculated aspect ratio for the shot
                photoDiv.style.aspectRatio = shotAspectRatio;

                const imageDataUrl = capturedImages[i];

                if (imageDataUrl) {
                    const img = createStripImage(imageDataUrl, activeFilter); 
                    photoDiv.appendChild(img);
                } else {
                    // Fallback for missing shot data
                    photoDiv.textContent = `Photo ${i + 1}`;
                }

                // Insert the shot div before the sticker layer, text layer, or footer (whichever is first)
                photoStrip.insertBefore(photoDiv, insertBeforeElement);
            }

            
            // Button Functionality
            const sendBtn = document.getElementById('send-btn');
            const downloadBtn = document.getElementById('download-btn');

            // --- Capture Helper Function (Refactored from Download logic for re-use in POST) ---
            const capturePhotoStripForUpload = () => {
                return new Promise(async (resolve, reject) => {
                    const draggableTexts = photostripElement.querySelectorAll('.draggable-text');
                    const photoContainers = photostripElement.querySelectorAll('.photo-strip-image');
                    
                    const originalData = [];
                    
                    // Re-apply filters via canvas before capture (similar to download logic)
                    const filterPromises = Array.from(photoContainers).map((container, index) => {
                        return new Promise(filterResolve => {
                            const img = container.querySelector('img');
                            const originalImageDataUrl = capturedImages[index]; 
                            const filterClass = activeFilter;
                            
                            if (img && originalImageDataUrl && filterClass !== 'filter-none') {
                                // Store original state and remove CSS filter class
                                originalData.push({ element: img, originalSrc: img.src, originalClasses: img.className });
                                img.classList.remove(filterClass);

                                // Apply the filter via canvas and update the img.src
                                window.applyFilterToCanvas(originalImageDataUrl, filterClass, (filteredDataUrl) => {
                                    img.src = filteredDataUrl;
                                    filterResolve();
                                });
                            } else {
                                if (img) {
                                    originalData.push({ element: img, originalSrc: img.src, originalClasses: img.className });
                                    img.classList.remove(filterClass);
                                }
                                filterResolve();
                            }
                        });
                    });

                    await Promise.all(filterPromises);

                    // Temporarily hide drag/resize handles and dashed borders
                    draggableTexts.forEach(el => {
                        el.style.border = '1px dashed transparent'; 
                        el.querySelectorAll('.resize-handle, .remove-handle').forEach(handle => {
                            handle.style.display = 'none';
                        });
                    });

                    // Capture the image after filters are applied and handles are hidden
                    setTimeout(async () => {
                        try {
                            const canvas = await html2canvas(photostripElement, {
                                scale: 3, 
                                useCORS: true, 
                                allowTaint: true, 
                            });
                            
                            // Revert all changes immediately after capture
                            originalData.forEach(data => {
                                data.element.src = data.originalSrc;
                                data.element.className = data.originalClasses; // Re-apply all original classes
                            });

                            draggableTexts.forEach(el => {
                                el.style.border = ''; 
                                el.querySelectorAll('.resize-handle, .remove-handle').forEach(handle => {
                                    handle.style.display = ''; 
                                });
                            });

                            resolve(canvas);
                        } catch (error) {
                            console.error("Error during photo strip capture:", error);
                            // Ensure cleanup happens even on error
                            originalData.forEach(data => {
                                data.element.src = data.originalSrc;
                                data.element.className = data.originalClasses; 
                            });
                            draggableTexts.forEach(el => {
                                el.style.border = '';
                                el.querySelectorAll('.resize-handle, .remove-handle').forEach(handle => {
                                    handle.style.display = '';
                                });
                            });
                            reject(error);
                        }
                    }, 50); // Small delay to ensure DOM updates are processed
                });
            };

            // --------------------------------------------------------------------------------
            // --- DOWNLOAD LOGIC (Now using capturePhotoStripForUpload) ---
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', async () => {
                    try {
                        const canvas = await capturePhotoStripForUpload();
                        
                        // Trigger Download
                        const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        const link = document.createElement('a');
                        link.download = 'webooth-photo-strip.png';
                        link.href = image;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                    } catch (error) {
                        alert('An error occurred during download. Check the console for details.');
                    }
                });
            }
            // --- END DOWNLOAD LOGIC ---


            // Background Functionality (Original logic preserved)
            const bgColorPicker = document.getElementById('bg-color');
            const bgImages = document.querySelectorAll('.bg-selection-item');

            if (photoStrip && bgColorPicker) {
                bgColorPicker.addEventListener('input', (e) => {
                    photoStrip.style.backgroundImage = 'none';
                    photoStrip.style.backgroundColor = e.target.value;
                    checkTemplateStatus(); // Check and update button on background change
                });
            }

            if (photoStrip && bgImages.length > 0) {
                bgImages.forEach(img => {
                    img.addEventListener('click', () => {
                        photoStrip.style.backgroundImage = `url(${img.src})`;
                        photoStrip.style.backgroundColor = 'transparent'; 
                        checkTemplateStatus(); // Check and update button on background change
                    });
                });
            }

            // Footer Checkbox Functionality
            const footerLogo = document.getElementById('footer-brand-logo');
            const footerDate = document.getElementById('footer-date-dynamic');
            const footerTime = document.getElementById('footer-time-dynamic');
            const footerWeBoothText = document.getElementById('footer-brand-text'); 
            
            // date/time generation
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const formattedDate = `${month}/${day}/${year}`;
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const formattedTime = `${hours}:${minutes} ${ampm}`;

            if (logoCheckbox && footerLogo && footerWeBoothText) {
                footerDate.textContent = formattedDate; 
                footerTime.textContent = formattedTime; 

                logoCheckbox.addEventListener('change', (e) => {
                    footerLogo.classList.toggle('hidden', !e.target.checked);
                    footerWeBoothText.classList.toggle('hidden', !e.target.checked);
                    checkTemplateStatus(); // Check and update button on footer change
                });

                dateCheckbox.addEventListener('change', (e) => {
                    footerDate.classList.toggle('hidden', !e.target.checked);
                    checkTemplateStatus(); // Check and update button on footer change
                });

                timeCheckbox.addEventListener('change', (e) => {
                    footerTime.classList.toggle('hidden', !e.target.checked);
                    checkTemplateStatus(); // Check and update button on footer change
                });
            }
            
            
            // --- CONTENT HASH GENERATION ---
            const getTemplateContentString = (templateState) => {
                const dataToHash = {
                    // ... other properties
                    // Sorting is CRITICAL for predictable hashing
                    // USE OF `?? []` ENSURES .sort() IS ALWAYS CALLED ON AN ARRAY
                    text: JSON.stringify(templateState.text?.sort((a, b) => {
                        if (a.text > b.text) return 1;
                        if (a.text < b.text) return -1;
                        return 0;
                    }) ?? []) // <- The fix is ensuring it's an array before sorting
                };
                return JSON.stringify(dataToHash);
            };
            
            const generateTemplateHashId = (templateState) => {
                const contentString = getTemplateContentString(templateState);
                // Use SHA-256 and truncate for a shorter ID (16 chars)
                return CryptoJS.SHA256(contentString).toString(CryptoJS.enc.Hex).substring(0, 16); 
            };

            let lastSavedHash = null; 

            // --- Function to Collect Template State ---
            const collectTemplateState = (templateImgUrl, userId) => {
                
                // Get all draggable text data
                const draggableTexts = Array.from(textOverlayLayer.querySelectorAll('.draggable-text')).map(el => {
                    return {
                        text: el.textContent,
                        fontFamily: el.style.fontFamily,
                        color: el.style.color,
                        left: el.style.left,
                        top: el.style.top,
                        width: el.style.width,
                        fontSize: el.style.fontSize
                    };
                });

                // Determine background value (color or URL)
                let backgroundValue;
                if (photoStrip.style.backgroundImage && photoStrip.style.backgroundImage !== 'none') {
                    backgroundValue = photoStrip.style.backgroundImage.replace(/^url\(['"]?(.+)['"]?\)$/, '$1');
                } else {
                    backgroundValue = photoStrip.style.backgroundColor || '#ffffff'; 
                }
            
                const templateState = {
                    sticker: localStorage.getItem('activeStickerBase') || null,
                    text: draggableTexts,
                    font: fontSelect.value,
                    text_color: textColorPicker.value,
                    background: backgroundValue, 
                    show_logo: String(logoCheckbox.checked),
                    show_date: String(dateCheckbox.checked),
                    show_time: String(timeCheckbox.checked),
                    frame_size: frameSize,
                    shot_count: shotCount,
                    share: 'false', 
                    effects: activeFilter,
                    template_img: templateImgUrl, 
                    name: 'Custom Template', 
                };

                const hashId = generateTemplateHashId(templateState);
                
                return {
                    action: 'saveTemplateState',
                    user_id: userId,
                    template_id: hashId, // Use the predictable ID
                    template_state: templateState
                };
            };

            // --- SAVE BUTTON VISUAL LOGIC ---
            const setSaveButtonState = (isSaved) => {
                if (isSaved) {
                    saveBtn.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'; // Checkmark icon
                    saveBtn.classList.add('saved-state'); 
                    saveBtn.classList.remove('unsaved-state');
                    saveBtn.title = "Template Saved";
                } else {
                    saveBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3-7 3V5z"></path></svg>'; // Bookmark icon
                    saveBtn.classList.remove('saved-state');
                    saveBtn.classList.add('unsaved-state');
                    saveBtn.title = "Save Template";
                }
            };

            const checkTemplateStatus = () => {
                if (!window.currentUserId || lastSavedHash === null) {
                    setSaveButtonState(false);
                    return;
                }
                
                const currentState = collectTemplateState(null, window.currentUserId);
                const currentHash = currentState.template_id;
                
                setSaveButtonState(currentHash === lastSavedHash);
            };
            
            // --- JAVASCRIPT FOR DRAGGABLE TEXT (Modified to call checkTemplateStatus) ---
            
            const addTextBtn = document.getElementById('add-text-btn');
            const customTextInput = document.getElementById('custom-text'); 
            
            const updateTextStyles = () => {
                const newColor = textColorPicker.value;
                const newFontFamily = fontSelect.value;
                const activeTextElements = photoStrip.querySelectorAll('.draggable-text, .footer-display:not(.hidden)'); 
                activeTextElements.forEach(el => {
                    el.style.fontFamily = `'${newFontFamily}', sans-serif`;
                    el.style.color = newColor;
                });
                checkTemplateStatus(); 
            };
            fontSelect.addEventListener('change', updateTextStyles);
            textColorPicker.addEventListener('input', updateTextStyles);


            if (addTextBtn && photoStrip) {
                addTextBtn.addEventListener('click', () => {
                    const text = customTextInput.value; 
                    if (text.trim() === '') {
                        alert('Please type some text first!');
                        return;
                    }
                    
                    const color = textColorPicker.value;
                    const font = fontSelect.value;
                    
                    const newTextElement = document.createElement('div');
                    newTextElement.textContent = text;
                    newTextElement.style.color = color;
                    newTextElement.style.fontFamily = `'${font}', sans-serif`;
                    newTextElement.classList.add('draggable-text');
                    newTextElement.style.left = '20px'; 
                    newTextElement.style.top = '20px'; 
                    newTextElement.style.pointerEvents = 'auto'; 

                    const resizeHandleFont = document.createElement('div');
                    resizeHandleFont.classList.add('resize-handle', 'resize-handle-font');
                    newTextElement.appendChild(resizeHandleFont);

                    const resizeHandleWidth = document.createElement('div');
                    resizeHandleWidth.classList.add('resize-handle', 'resize-handle-width');
                    newTextElement.appendChild(resizeHandleWidth);

                    const removeHandle = document.createElement('div');
                    removeHandle.classList.add('remove-handle');
                    removeHandle.innerHTML = '&#x2715;'; 
                    newTextElement.appendChild(removeHandle);

                    textOverlayLayer.appendChild(newTextElement);

                    makeDraggableAndResizable(newTextElement, resizeHandleFont, resizeHandleWidth, removeHandle);
                    checkTemplateStatus(); 
                });
            }
            
            function makeDraggableAndResizable(element, fontHandle, widthHandle, removeHandle) {
                let isDragging = false;
                let isResizingFont = false;
                let isResizingWidth = false;

                let initialFontSize = 16; 
                let initialWidth = element.clientWidth;
                let startMouseX, startMouseY;
                let offsetX, offsetY;
                
                element.style.fontSize = `${initialFontSize}px`;
                
                const observer = new MutationObserver(checkTemplateStatus);
                observer.observe(element, { attributes: true, attributeFilter: ['style'] });


                element.addEventListener('mousedown', (e) => {
                    if (e.target === element) {
                        isDragging = true;
                        offsetX = e.clientX - element.getBoundingClientRect().left;
                        offsetY = e.clientY - element.getBoundingClientRect().top;
                        element.style.opacity = '0.7'; 
                        e.preventDefault();
                    }
                });
                
                fontHandle.addEventListener('mousedown', (e) => {
                    isResizingFont = true;
                    startMouseX = e.clientX;
                    startMouseY = e.clientY;
                    initialFontSize = parseFloat(window.getComputedStyle(element).fontSize);
                    element.style.opacity = '0.7';
                    e.preventDefault();
                    e.stopPropagation(); 
                });

                widthHandle.addEventListener('mousedown', (e) => {
                    isResizingWidth = true;
                    startMouseX = e.clientX;
                    initialWidth = element.clientWidth;
                    element.style.opacity = '0.7';
                    e.preventDefault();
                    e.stopPropagation(); 
                });

                removeHandle.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    element.remove();
                    checkTemplateStatus(); 
                });
                
                element.addEventListener('dblclick', (e) => {
                    if (e.target.classList.contains('resize-handle') || e.target.classList.contains('remove-handle')) return;
                    
                    element.contentEditable = true;
                    element.focus();
                    element.classList.add('is-editing');
                });
                
                element.addEventListener('blur', () => {
                    element.contentEditable = false;
                    element.classList.remove('is-editing');
                    if (element.textContent.trim() === '') {
                        element.remove();
                        checkTemplateStatus(); 
                    } else {
                        checkTemplateStatus(); 
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    const overlayRect = textOverlayLayer.getBoundingClientRect();

                    if (isDragging) {
                        let newX = e.clientX - overlayRect.left - offsetX;
                        let newY = e.clientY - overlayRect.top - offsetY;
                        
                        newX = Math.max(0, Math.min(newX, overlayRect.width - element.offsetWidth));
                        newY = Math.max(0, Math.min(newY, overlayRect.height - element.offsetHeight));

                        element.style.left = `${newX}px`;
                        element.style.top = `${newY}px`;
                    } else if (isResizingFont) {
                        const dx = e.clientX - startMouseX;
                        const dy = e.clientY - startMouseY;
                        const distance = Math.max(dx, dy); 
                        
                        const newFontSize = Math.max(8, initialFontSize + (distance * 0.5)); 
                        element.style.fontSize = `${newFontSize}px`;
                    
                    } else if (isResizingWidth) {
                        const dx = e.clientX - startMouseX;
                        const newWidth = Math.max(50, initialWidth + dx); 
                        
                        const currentX = parseFloat(element.style.left);
                        const maxWidth = overlayRect.width - currentX;
                        
                        element.style.width = `${Math.min(newWidth, maxWidth)}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    isResizingFont = false;
                    isResizingWidth = false;
                    element.style.opacity = '1'; 
                });
            }

            // --- STICKER SELECTION LOGIC (Modified to call checkTemplateStatus) ---
            const stickerButtons = document.querySelectorAll('.sticker-button');
            const noStickerButton = document.querySelector('.pack-button[data-pack-name="No Stickers"]');


            stickerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const imgElement = button.querySelector('img');
                    const basePath = imgElement.dataset.baseSrc; 

                    const currentFrameSize = localStorage.getItem('frameSize') || '2x6';
                    const sizeTag = currentFrameSize === '4x6' ? '4 x 6 in' : '2 x 6 in';
                    const stickerTag = currentFrameSize === '4x6' ? '4x6' : '2x6';

                    if (basePath) {
                        const finalStickerSrc = basePath
                            .replace('(X in)', `(${sizeTag})`) 
                            .replace(/X/g, stickerTag); 
                            
                        if (stickerOverlay) {
                            stickerOverlay.src = finalStickerSrc;
                            stickerOverlay.style.display = 'block';
                        }
                        
                        localStorage.setItem('activeStickerBase', basePath);
                    }
                    checkTemplateStatus(); 
                });
            });
            
            if (noStickerButton && stickerOverlay && photoStrip) {
                noStickerButton.addEventListener('click', () => {
                    stickerOverlay.style.display = 'none';
                    localStorage.removeItem('activeStickerBase');
                    checkTemplateStatus(); 
                });
            }

            // --- MODAL JAVASCRIPT LOGIC (Original logic preserved, POST button modified) ---
            const mainPostBtn = document.getElementById('main-post-btn');
            const modalOverlay = document.getElementById('post-modal-overlay');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalPostBtn = document.getElementById('modal-post-btn');
            const photoTitleInput = document.getElementById('photo-title-input');
            const photoDescriptionTextarea = document.getElementById('photo-description-textarea');
            const shareToggle = document.getElementById('share-to-community-toggle');

            const showModal = () => {
                if (modalOverlay) {
                    modalOverlay.style.display = 'flex';
                    photoTitleInput.value = '';
                    photoDescriptionTextarea.value = '';
                    shareToggle.checked = true;
                }
            };

            const hideModal = () => {
                if (modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            };

            if (mainPostBtn) {
                mainPostBtn.addEventListener('click', showModal);
            }

            if (modalCancelBtn) {
                modalCancelBtn.addEventListener('click', hideModal);
            }

            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        hideModal();
                    }
                });
            }

            // --- POST BUTTON IMPLEMENTATION (MODIFIED) ---
            if (modalPostBtn) {
                modalPostBtn.addEventListener('click', async () => {
                    const userId = window.checkAuthAndGetUid();
                    if (!userId) {
                        hideModal();
                        return;
                    }
                    
                    modalPostBtn.disabled = true;
                    modalPostBtn.textContent = 'Posting...';

                    const title = photoTitleInput.value;
                    const description = photoDescriptionTextarea.value;
                    const share = shareToggle.checked;
                    
                    try {
                        // 1. CAPTURE THE FINAL IMAGE
                        const canvas = await capturePhotoStripForUpload();
                        
                        // 2. CONVERT TO BLOB AND UPLOAD TO FIREBASE
                        const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const imageURL = await window.uploadPostImage(imageBlob, userId);
                        
                        // 3. LOG ACTIVITY 
                        const activityPostData = {
                            action: 'addActivity',
                            user_id: userId,
                            activity: `Posted a new photo: "${title || 'Untitled'}"`
                        };
                        // Note: Ignoring result of activity log
                        fetch('http://localhost:80/api.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(activityPostData)
                        });
                        
                        // 4. SAVE POST DETAILS TO SUPABASE (PostgreSQL)
                        const postData = {
                            action: 'createPost', // <<< NEW ACTION
                            user_id: userId,
                            image_url: imageURL,
                            title: title,
                            description: description,
                            share_to_community: String(share),
                            template_hash_id: generateTemplateHashId(collectTemplateState(null, userId)) 
                        };

                        const response = await fetch('http://localhost:80/api.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(postData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            console.log('Post created successfully with ID:', result.post_id);
                            window.location.href = `finalprof.html`;

                            
                        } else {
                            console.error("API Error posting photo:", result.error);
                        
                        }
                        
                    } catch (error) {
                        console.error("Post creation failed:", error);
                        alert('A critical error occurred during the posting process.');
                    } finally {
                        modalPostBtn.disabled = false;
                        modalPostBtn.textContent = 'Post';
                        hideModal();
                    }
                });
            }
            // --- END POST BUTTON IMPLEMENTATION ---
            
            // --- SAVE BUTTON IMPLEMENTATION (Modified for Hash ID and Status Update) ---
            if (saveBtn) {
                
                // Recheck status when the user becomes authenticated (Moved this outside DOMContentLoaded for proper module scope)
                // We'll rely on the initial onAuthStateChanged block to set window.currentUserId

                saveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    // 1. Get User ID 
                    const userId = window.checkAuthAndGetUid();
                    if (!userId) return;

                    // Disable button and show loading state
                    saveBtn.disabled = true;

                    try {
                        // 2. Create the off-screen template image (placeholder shots)
                        const imageBlob = await createOffScreenTemplate(photostripElement);
                        
                        // 3. Upload the placeholder image using the real Firebase Storage function
                        const templateImgUrl = await window.uploadTemplateImage(imageBlob, userId);

                        // 4. Collect state and get the Hash ID
                        const postData = collectTemplateState(templateImgUrl, userId);
                        const currentHash = postData.template_id;

                        // 5. Send to PHP backend for UPSERT (Supabase/PostgreSQL)
                        console.log("Saving template state to Supabase with ID:", currentHash);
                        
                        const response = await fetch('http://localhost:80/api.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(postData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            // On successful save (or if already existed)
                            lastSavedHash = currentHash;
                            setSaveButtonState(true); 
                            
                            let message = 'Template saved successfully!';
                            if (result.message.includes('already exists')) {
                                message = 'Template already saved!';
                            }
                            console.log(message, 'ID:', currentHash);
                            
                        } else {
                            console.error("API Error posting template:", result.error);
                            setSaveButtonState(false);
                        }
                    } catch (error) {
                        console.error("Unexpected error in template Save:", error);
                        setSaveButtonState(false);
                    } finally {
                        saveBtn.disabled = false;
                    }
                });
            }

            // Add event listeners to detect changes and unset the 'saved' state
            document.querySelectorAll('.item-placeholder, .bg-selection-item').forEach(el => {
                el.addEventListener('click', checkTemplateStatus);
            });
            
            document.getElementById('custom-text').addEventListener('input', checkTemplateStatus);
            
            // Initial button state (unsaved)
            setSaveButtonState(false);

            // --- Function to Create Off-Screen Template Image (Unchanged) ---
            const createOffScreenTemplate = async (originalElement) => {
                
                // 1. Create off-screen working area
                const offScreenContainer = document.createElement('div');
                offScreenContainer.style.position = 'absolute';
                offScreenContainer.style.left = '-9999px'; // Hide off-screen
                // Clone the styles needed for sizing and layout
                offScreenContainer.style.width = originalElement.offsetWidth + 'px'; 
                offScreenContainer.style.height = originalElement.offsetHeight + 'px';
                document.body.appendChild(offScreenContainer);

                // 2. Clone the original element
                const clonedStrip = originalElement.cloneNode(true);
                offScreenContainer.appendChild(clonedStrip);
                
                // 3. Locate and modify the shot containers in the CLONE
                const photoContainers = clonedStrip.querySelectorAll('.photo-strip-image');
                
                photoContainers.forEach(container => {
                    // a. Remove the actual captured image element if it exists
                    const existingImg = container.querySelector('img');
                    if (existingImg) {
                        existingImg.remove();
                    }
                    
                    // b. Set the placeholder background/text for the template image
                    container.textContent = 'Photo Placeholder';
                    container.style.backgroundColor = '#d1d5db'; 
                    container.style.display = 'flex'; 
                    container.style.alignItems = 'center';
                    container.style.justifyContent = 'center';
                    container.style.color = '#4b5563';
                });
                
                // 4. Temporarily hide drag/resize handles on the cloned text elements
                clonedStrip.querySelectorAll('.draggable-text').forEach(el => {
                    el.style.border = '1px dashed transparent'; 
                    el.querySelectorAll('.resize-handle, .remove-handle').forEach(handle => {
                        handle.style.display = 'none';
                    });
                });

                // 5. Capture the off-screen clone
                const canvas = await html2canvas(clonedStrip, {
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true, 
                    backgroundColor: null 
                });
                
                // 6. Cleanup: Remove the off-screen container immediately
                offScreenContainer.remove();

                // 7. Convert canvas to Blob
                return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            };
            
        });
        // END OF CONSOLIDATED MODULE SCRIPT
    </script>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col justify-center p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row items-center md:items-baseline justify-between gap-4 mb-8">
            <div class="flex items-center">
                <img src="Icons/11.svg" alt="WeBooth Logo" 
                    class="w-12 h-12 md:w-16 md:h-16 mr-3"
                    onerror="this.outerHTML = '<div class=\'icon-fallback p-2 text-xl\'>W</div>'">
                
                <h1 class="text-2xl md:text-3xl text-brand-pink leading-tight font-fredoka">
                    Customize Your Photo
                </h1>
            </div>

            <div class="flex flex-col items-center md:items-end">
                <header class="topbar">
                    
        <div class="right-buttons">
            <button onclick="window.location.href='mainhome.html'">
                <img src="Icons/2.svg" alt="Booth icon" />
                Booth
            </button>
            <button onclick="window.location.href='finalprof.html'">
                <img src="Icons/4.svg" alt="Profile icon" />
                Profile
            </button>
        </div>
      </header>

            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 flex flex-col gap-8 justify-start"> 
                
                <div class="stacked-custom-section-container" id="sticker-section-container">
                    <h2 class="custom-section-title" id="sticker-section-title">Sticker Packs</h2>
                    <div id="pack-grid">
                        <div class="item-grid">
                            
                            <button class="item-placeholder pack-button" data-pack-name="No Stickers">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                                </svg>
                                <span class="sr-only">No Stickers</span>
                            </button>

                            
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/birthday2x6.png" alt="Sticker 2" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/birthdayX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/cat2x6.png" alt="Sticker 3" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/catX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/butterfly2x6.png" alt="Sticker 4" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/butterflyX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/comic2x6.png" alt="Sticker 5" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/comicX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/cat2x6.png" alt="Sticker 6" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/catX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/dog2x6.png" alt="Sticker 7" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/dogX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/doodle2x6.png" alt="Sticker 8" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/doodleX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/fairy2x6.png" alt="Sticker 9" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/fairyX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/kitten2x6.png" alt="Sticker 10" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/kittenX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/flower2x6.png" alt="Sticker 11" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/flowerX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/doodle2x6.png" alt="Sticker 12" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/doodleX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/dog2x6.png" alt="Sticker 13" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/dogX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/capybara2x6.png" alt="Sticker 14" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/capybaraX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/kitten2x6.png" alt="Sticker 15" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/kittenX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/cafe2x6.png" alt="Sticker 16" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/cafeX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/flower2x6.png" alt="Sticker 17" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/flowerX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/fairy2x6.png" alt="Sticker 18" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/fairyX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/bear2x6.png" alt="Sticker 19" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/bearX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/doodle2x6.png" alt="Sticker 20" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/doodleX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/travel2x6.png" alt="Sticker 21" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/travelX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/vinyl2x6.png" alt="Sticker 22" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/vinylX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/xoxo2x6.png" alt="Sticker 23" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/xoxoX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/bear2x6.png" alt="Sticker 24" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/bearX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/butterfly2x6.png" alt="Sticker 25" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/butterflyX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/flower2x6.png" alt="Sticker 26" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/flowerX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/blue2x6.png" alt="Sticker 27" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/blueX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/brownie2x6.png" alt="Sticker 28" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/brownieX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/blue2x6.png" alt="Sticker 29" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/blueX.png">
                            </button>
                            <button class="item-placeholder sticker-button" style="padding: 0.25rem;">
                                <img src="sticker pack (2 x 6 in)/butterfly2x6.png" alt="Sticker 30" class="w-full h-full object-cover rounded-lg" data-base-src="sticker pack (X in)/butterflyX.png">
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="stacked-custom-section-container">
                    <h2 class="custom-section-title">Text</h2>
                    <div class="flex flex-col gap-4">
                        <div>
                            <textarea id="custom-text" placeholder="Type here..." class="custom-input" rows="3"></textarea>
                        </div>
                        <div>
                            <button id="add-text-btn" class="action-button w-full justify-center" style="margin-bottom: 0; padding-top: 0.65rem; padding-bottom: 0.65rem; font-size: 1rem;">
                                Add Text to Strip
                            </button>
                        </div>
                        <div>
                            <select id="font-select" class="custom-select">
                                <option style="font-family: 'Poppins', sans-serif;">Poppins</option>
                                <option style="font-family: 'Montserrat', sans-serif;">Montserrat</option>
                                <option style="font-family: 'Roboto', sans-serif;">Roboto</option>
                                <option style="font-family: 'Open Sans', sans-serif;">Open Sans</option>
                                <option style="font-family: 'Lora', serif;">Lora</option>
                                <option style="font-family: 'Raleway', sans-serif;">Raleway</option>
                                <option style="font-family: 'Playfair Display', serif;">Playfair Display</option>
                                <option style="font-family: 'Nunito', sans-serif;">Nunito</option>
                                <option style="font-family: 'Merriweather', serif;">Merriweather</option>
                                <option style="font-family: 'Quicksand', sans-serif;">Quicksand</option>
                                <option style="font-family: 'Ubuntu', sans-serif;">Ubuntu</option>
                                <option style="font-family: 'Oswald', sans-serif;">Oswald</option>
                                <option style="font-family: 'DM Sans', sans-serif;">DM Sans</option>
                                <option style="font-family: 'Cabin', sans-serif;">Cabin</option>
                                <option style="font-family: 'Lobster', cursive;">Lobster</option>
                            </select>
                        </div>
                        
                        <div>
                           <label class="color-picker-wrapper">
                                <span>Text Color</span>
                                <input type="color" id="text-color" class="color-picker-input" value="#c32d6c">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col gap-8 justify-start"> 
                <div class="custom-section-container">
                    <h2 class="custom-section-title">Backgrounds</h2>
                    <div class="item-grid" id="background-grid"> 
                        
                        <label class="color-picker-grid-item">
                            <div class="icon"></div>
                            <input type="color" id="bg-color" value="#FFFFFF" class="opacity-0 absolute inset-0 w-full h-full">
                            <span class="sr-only">Custom Background Color</span>
                        </label>
                        
                        <img src="Bg_svg_1/1.svg.png" alt="Background 1" class="bg-selection-item">
                        <img src="Bg_svg_1/2.svg.png" alt="Background 2" class="bg-selection-item">
                        <img src="Bg_svg_1/3.svg.png" alt="Background 3" class="bg-selection-item">
                        <img src="Bg_svg_1/4.svg.png" alt="Background 4" class="bg-selection-item">
                        <img src="Bg_svg_1/5.svg.png" alt="Background 5" class="bg-selection-item">
                        <img src="Bg_svg_1/6.svg.png" alt="Background 6" class="bg-selection-item">
                        <img src="Bg_svg_1/7.svg.png" alt="Background 7" class="bg-selection-item">
                        <img src="Bg_svg_1/8.svg.png" alt="Background 8" class="bg-selection-item">
                        <img src="Bg_svg_1/9.svg.png" alt="Background 9" class="bg-selection-item">
                        <img src="Bg_svg_1/10.svg.png" alt="Background 10" class="bg-selection-item">
                        <img src="Bg_svg_1/11.svg.png" alt="Background 11" class="bg-selection-item">
                        <img src="Bg_svg_1/12.svg.png" alt="Background 12" class="bg-selection-item">
                        <img src="Bg_svg_1/13.svg.png" alt="Background 13" class="bg-selection-item">
                        <img src="Bg_svg_1/14.svg.png" alt="Background 14" class="bg-selection-item">
                        <img src="Bg_svg_1/15.svg.png" alt="Background 15" class="bg-selection-item">
                        <img src="Bg_svg_1/16.svg.png" alt="Background 16" class="bg-selection-item">
                        <img src="Bg_svg_1/17.svg.png" alt="Background 17" class="bg-selection-item">
                        <img src="Bg_svg_1/18.svg.png" alt="Background 18" class="bg-selection-item">
                        <img src="Bg_svg_1/19.svg.png" alt="Background 19" class="bg-selection-item">
                        <img src="Bg_svg_1/20.svg.png" alt="Background 20" class="bg-selection-item">
                        <img src="Bg_svg_1/21.svg.png" alt="Background 21" class="bg-selection-item">
                        <img src="Bg_svg_1/22.svg.png" alt="Background 22" class="bg-selection-item">
                        <img src="Bg_svg_1/23.svg.png" alt="Background 23" class="bg-selection-item">
                        <img src="Bg_svg_1/24.svg.png" alt="Background 24" class="bg-selection-item">
                        <img src="Bg_svg_1/25.svg.png" alt="Background 25" class="bg-selection-item">
                        <img src="Bg_svg_1/26.svg.png" alt="Background 26" class="bg-selection-item">
                        <img src="Bg_svg_1/27.svg.png" alt="Background 27" class="bg-selection-item">
                        <img src="Bg_svg_1/28.svg.png" alt="Background 28" class="bg-selection-item">
                        <img src="Bg_svg_1/29.svg.png" alt="Background 29" class="bg-selection-item">
                        <img src="Bg_svg_1/30.svg.png" alt="Background 30" class="bg-selection-item">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col items-center relative">
                
                <style>
                    /* Custom CSS for 2x2 Grid Layout (used for 4x6, 4 shots) */
                    /* NOTE: This block is kept in the HTML as a remnant of the original structure. 
                       For true separation, it should also be in customizationphoto-style.css. */
                    .photobooth-template-container.layout-grid-2x2 {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        align-content: center;
                        gap: 0.5rem;
                        padding-bottom: 0.5rem;
                        /* Ensure the footer/overlay covers the entire grid area */
                        grid-template-rows: auto 1fr auto; 
                    }
                    .photobooth-template-container.layout-grid-2x2 .sticker-overlay-layer,
                    .photobooth-template-container.layout-grid-2x2 #text-overlay-layer {
                        grid-column: 1 / -1;
                        grid-row: 1 / -1;
                        z-index: 10;
                    }
                    .photobooth-template-container.layout-grid-2x2 .template-footer {
                        grid-column: 1 / -1;
                        margin-top: auto;
                        width: 100%;
                    }
                    .photobooth-template-container.layout-grid-2x2 .photo-strip-image {
                        width: 100%;
                        aspect-ratio: 4 / 3; /* Standard photo aspect ratio for 4x6 grid */
                        margin-bottom: 0;
                    }
                    .sticker-overlay-layer {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        object-fit: contain; 
                        z-index: 50; 
                        pointer-events: none;
                    }
                    #text-overlay-layer {
                        position: absolute;
                        top: 0.5rem; 
                        left: 0.5rem;
                        width: calc(100% - 1rem); 
                        height: calc(100% - 0.5rem); 
                        z-index: 100; 
                        pointer-events: none; 
                    }
                    #text-overlay-layer .draggable-text {
                        pointer-events: auto; 
                    }
                </style>

                <div class="photobooth-template-container" id="photostrip-preview">
                    <img id="sticker-overlay" class="sticker-overlay-layer" src="" alt="" style="display: none;">
                    
                    <div id="text-overlay-layer">
                    </div>
                    
                    <div class="template-footer">
                        <div class="footer-brand">
                            <img id="footer-brand-logo" src="Icons_svg_1/11.svg" 
                                alt="WeBooth Logo" 
                                class="logo-footer hidden"
                                onerror="this.outerHTML = '<div class=\'w-8 h-8 rounded-full bg-slate-300 text-slate-600 flex items-center justify-center font-bold text-lg hidden\'>W</div>'">
                            <span id="footer-brand-text" class="footer-text font-fredoka hidden">WeBooth</span>
                        </div>
                        
                        <div class="footer-extras">
                            <span id="footer-time-dynamic" class="footer-display hidden"></span>
                            <span id="footer-date-dynamic" class="footer-display hidden"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-row items-center justify-center gap-4 mb-4"> <label class="flex items-center space-x-1.5 cursor-pointer text-brand-pink font-medium">
                        <input type="checkbox" id="logo-checkbox" class="w-5 h-5 rounded accent-[#c32d6c] border-gray-300 focus:ring-[#c32d6c]"/>
                        <span>Logo</span>
                    </label>
                    <label class="flex items-center space-x-1.5 cursor-pointer text-brand-pink font-medium">
                        <input type="checkbox" id="date-checkbox" class="w-5 h-5 rounded accent-[#c32d6c] border-gray-300 focus:ring-[#c32d6c]"/>
                        <span>Date</span>
                    </label>
                    <label class="flex items-center space-x-1.5 cursor-pointer text-brand-pink font-medium">
                        <input type="checkbox" id="time-checkbox" class="w-5 h-5 rounded accent-[#c32d6c] border-gray-300 focus:ring-[#c32d6c]"/>
                        <span>Time</span>
                    </label>
                </div>

                <div class="flex items-center gap-6">
                    <button class="action-button" id="main-post-btn">
                        POST
                    </button>
                </div>

                <div class="social-icons-vertical">
                    <button class="social-icon-button unsaved-state" id="save-btn" title="Save Template">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3-7 3V5z"></path></svg>
                    </button>
                    <button class="social-icon-button" id="send-btn" title="Send / Share">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                    <button class="social-icon-button" id="download-btn" title="Download">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                </div>

            </div>

        </main>
    </div>

    <div id="post-modal-overlay" class="modal-overlay">
        <div class="modal-content" id="post-modal-content">
            <div class="modal-content-inner">
                <h3 class="modal-title font-fredoka">Photo Details</h3>
                
                <label for="photo-title-input" class="modal-label">Photo Title</label>
                <input type="text" id="photo-title-input" placeholder="Give your photo a fun title!" class="modal-input">

                <label for="photo-description-textarea" class="modal-label">Description</label>
                <textarea id="photo-description-textarea" placeholder="Describe your moment..." class="modal-textarea" rows="3"></textarea>

                <div class="custom-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="share-to-community-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="text-brand-pink font-medium">Share to community</span>
                </div>
                
                <div class="flex justify-end gap-3 mt-8">
                    <button id="modal-cancel-btn" class="modal-button-cancel">Cancel</button>
                    <button id="modal-post-btn" class="modal-button-post">Post</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>