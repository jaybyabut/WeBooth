<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="tab-icon.png" />
    <title>Review Your Shots or Retake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Fredoka+One&display=swap" rel="stylesheet">

    <style>
        body {
            background: radial-gradient(circle, #d4e893 40%, #feefff 60%);
            font-family: 'Inter', 'DM Sans', sans-serif, 'Fredoka One', cursive;
            min-height: 100vh;
        }

        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }

        .text-brand-pink {
            color: #c32d6c;
        }

        .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .topbar h1 {
      font-family: 'Fredoka One', cursive;
      font-size: 40px;
      font-weight: 900;
      color: #d23481;
      margin: 0;
      letter-spacing: -1px;
    }

    .right-buttons {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .right-buttons button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: 2px solid #d23481;
      background-color: #fff;
      color: #d23481;
      transition: background-color 0.3s, color 0.3s;
    }

    .right-buttons button img {
      width: 28px;
      height: 28px;
    }

    .right-buttons button:hover,
    .admin-btn {
      background-color: #d23481;
      color: #fff;
      border: 2px solid #d23481;
    }


        
        .card {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(221, 61, 147, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        /* Thumbnail Placeholder Styles */
        .image-placeholder {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 1.5rem;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-weight: 500;
            overflow: hidden; 
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        
        .image-placeholder:hover {
            transform: scale(1.03);
        }

        .image-placeholder.active-shot {
            border-color: #dd3d93;
            box-shadow: 0 0 10px rgba(221, 61, 147, 0.5);
        }

        /* Filter Classes (Must match filters from mainhome.html) */
        .filter-none { filter: none; }
        .filter-bw { filter: grayscale(100%); }
        .filter-warm { filter: sepia(70%); }
        .filter-cool { filter: contrast(1.1) brightness(1.1) saturate(1.3) hue-rotate(-15deg); }
        .filter-retro { filter: sepia(100%) brightness(0.9) contrast(1.1); }
        .filter-noir { filter: grayscale(100%) contrast(1.2) brightness(0.8); }

        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-size: 1.125rem;
            font-weight: 700;
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            background: linear-gradient(90deg, #f645b1 0%, #f4b744 100%);
            color: white;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s ease;
            text-decoration: none;
            border: none;
        }

        .action-button:hover {
            background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%);
        }

        .action-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        
        .action-button-outline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-size: 1.125rem;
            font-weight: 700;
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            
            
            background: #fff; 
            color: #f645b1; 
            border: 2px solid #f645b1; 

            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
        }
        
        .action-button-outline:hover {
            background: linear-gradient(90deg, #f4b744 0%, #f645b1 100%);
            color: white;
            border-color: transparent;
        }

        .action-button-outline:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        
        .icon-fallback {
            width: 1.25rem;
            height: 1.25rem;
            background-color: #cbd5e1;
            color: #475569;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col justify-center p-4 md:p-8">
        <header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
            <div class="flex items-center">
                <img src="Icons/11.svg" alt="WeBooth Logo"
                     class="w-12 h-12 md:w-16 md:h-16 mr-3"
                     onerror="this.outerHTML = '<div class=\'icon-fallback p-2 text-xl\'>W</div>'">
                
                <h1 class="text-2xl md:text-3xl text-brand-pink leading-tight font-fredoka">
                    Review Your Shots or Retake
                </h1>
            </div>

            <header class="topbar">
        <div class="right-buttons">
          <button onclick="window.location.href='mainhome.html'">
            <img src="Icons/2.svg" alt="Booth icon" />
            Booth
          </button>
          <button onclick="window.location.href='finalprof.html'">
            <img src="Icons/4.svg" alt="Profile icon" />
            Profile
          </button>
          <div id="admin-button-container" style="display:none;">
            <button onclick="window.location.href='admin.html'">
              <img src="Icons/3.svg" alt="Admin icon" />
              Admin
            </button>
          </div>
          </div>
      </header>

        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div id="shot-grid" class="lg:col-span-1 grid grid-cols-2 **gap-x-5 gap-y-0**">
                </div>

            <div class="lg:col-span-2 flex flex-col items-center">
                
                <div id="main-preview" class="w-full h-[400px] md:h-[400px] bg-gradient-to-b from-white-200 to-white-200 rounded-2xl flex items-center justify-center border-4 border-white shadow-xl mb-6 overflow-hidden">
                    <div class="text-white text-2xl font-bold bg-black/30 p-4 rounded-xl">
                        Select a Shot to Preview
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <button id="retake-btn" class="action-button-outline"> 
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                             <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                             <circle cx="12" cy="13" r="3" />
                         </svg>
                         RETAKE
                     </button>
                    <button id="done-button" class="action-button">
                        DONE
                    </button>
                </div>
                 </div>

        </main>
    </div>

 <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbSE2lqLfQCZU4L4a0hNfpM1ud11I854w",
      authDomain: "photobooth-c42a9.firebaseapp.com",
      projectId: "photobooth-c42a9",
      storageBucket: "photobooth-c42a9.firebasestorage.app",
      messagingSenderId: "994496567051",
      appId: "1:994496567051:web:81d507ace1fbd2db77b40e",
      measurementId: "G-4FHWWBR2BJ"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUserId = null;

    // --- APPLICATION STATE ---
    const state = {
      user: {
        isAdmin: false,
      }
    };

    /**
     * Fetches the user's profile from the DB or creates a default one via PHP API.
     */
    async function fetchOrCreateProfile(userId) {
      if (!userId) return;

      try {
        const response = await fetch('http://localhost:80/api.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'fetchOrCreateProfile',
            user_id: userId,
          })
        });

        const result = await response.json();

        if (result.success) {
          const isAdminValue = result.data.admin;
          // Check for 't' (PostgreSQL TRUE), true (JavaScript boolean), or 1
          state.user.isAdmin = (isAdminValue === true || isAdminValue === 't' || isAdminValue === 1); 
        } else {
          console.error("API Error fetching profile for admin check:", result.error);
          state.user.isAdmin = false;
        }
      } catch (error) {
        console.error("Unexpected fetch error in admin check:", error);
      }
      updateUserUI();
    }

    // --- UI Update Function ---
    function updateUserUI() {
        const adminButtonContainer = document.getElementById('admin-button-container');
        if (state.user.isAdmin) {
            adminButtonContainer.style.display = 'block';
        } else {
            adminButtonContainer.style.display = 'none';
        }
    }

    // --- Auth Listener ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        fetchOrCreateProfile(user.uid);
      } else {
        currentUserId = null;
      }
    });

    // --- MAIN DOMContentLoaded LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. GET DATA FROM LOCAL/SESSION STORAGE ---
        const activeFilter = localStorage.getItem('activeFilter') || 'filter-none';
        const frameSize = localStorage.getItem('frameSize') || '4x6'; 
        
        console.log('[reviewshots] DOMContentLoaded - localStorage state:');
        console.log('  - templateBackground:', localStorage.getItem('templateBackground'));
        console.log('  - templateStickers:', localStorage.getItem('templateStickers'));
        console.log('  - activeFilter:', activeFilter);
        console.log('  - frameSize:', frameSize);
        
        console.log('[reviewshots] DOMContentLoaded - sessionStorage state:');
        console.log('  - templateBackground:', sessionStorage.getItem('templateBackground'));
        console.log('  - templateStickers:', sessionStorage.getItem('templateStickers'));
        
        let capturedImages = [];
        try {
            const imagesJson = sessionStorage.getItem('capturedImagesArray');
            if (imagesJson) {
                capturedImages = JSON.parse(imagesJson);
            }
        } catch (e) {
            console.error("Error parsing captured images:", e);
        }
        
        // --- 2. GET DOM ELEMENTS & APPLY FRAME CLASS ---
        const shotGrid = document.getElementById('shot-grid');
        const mainPreview = document.getElementById('main-preview');
        const retakeButton = document.getElementById('retake-btn'); // Element now exists

        // Apply the saved frame size class
        if (mainPreview) {
            mainPreview.classList.remove('h-[400px]', 'md:h-[400px]');
            if (frameSize.includes('2x6')) {
                mainPreview.classList.add('frame-2x6');
            } else {
                mainPreview.classList.add('frame-4x6');
            }
        }
        
        /**
         * Helper function to create an image element with appropriate classes and filter
         * FIX APPLIED: Added 'block' and 'align-middle' to prevent vertical gaps (line-height issue).
         */
        const createImgElement = (src, filterClass = 'filter-none') => {
            const img = document.createElement('img');
            img.src = src;
            img.classList.add('w-full', 'h-full', 'object-cover', 'block', 'align-middle', filterClass);
            return img;
        };

        /**
         * Renders the given image in the main preview area.
         */
        const renderMainPreview = (imageDataUrl, filterClass) => {
            if (mainPreview && imageDataUrl) {
                mainPreview.innerHTML = ''; 
                const mainImg = createImgElement(imageDataUrl, filterClass);
                mainImg.classList.add('rounded-2xl');
                mainPreview.appendChild(mainImg);
            } else if (mainPreview) {
                mainPreview.innerHTML = `<div class="text-white text-2xl font-bold bg-black/30 p-4 rounded-xl">Select a Shot to Preview</div>`;
            }
        };
        
        // --- 3. DYNAMICALLY RENDER SHOTS ---
        
        shotGrid.innerHTML = '';
        
        if (capturedImages.length === 0) {
            shotGrid.innerHTML = '<p class="lg:col-span-2 p-4 text-center text-red-600">No photos were captured. Please use RETAKE on the previous page.</p>';
            renderMainPreview(null);
        }

        capturedImages.forEach((imageDataUrl, index) => {
            const shotNumber = index + 1;
            
            const placeholder = document.createElement('div');
            placeholder.classList.add('image-placeholder');
            placeholder.dataset.shotIndex = index; // Store index for click handling
            
            if (imageDataUrl) {
                const shotImg = createImgElement(imageDataUrl, activeFilter);
                placeholder.innerHTML = '';
                placeholder.appendChild(shotImg);
            } else {
                placeholder.textContent = `Shot ${shotNumber} Missing`;
            }
            
            // --- Click Handler for Shot Selection ---
            placeholder.addEventListener('click', () => {
                // 1. Update the main preview
                renderMainPreview(imageDataUrl, activeFilter);
                
                // 2. Update active class on thumbnails
                document.querySelectorAll('.image-placeholder').forEach(p => p.classList.remove('active-shot'));
                placeholder.classList.add('active-shot');
                
                // 3. Save the currently selected index and image for retake/done
                sessionStorage.setItem('selectedFinalImage', imageDataUrl);
                sessionStorage.setItem('retakeShotIndex', index.toString()); // Save the index!
            });
            
            shotGrid.appendChild(placeholder);
        });
        
        // --- 4. INITIAL DISPLAY ---

        if (capturedImages.length > 0 && capturedImages[0]) {
            const firstShotPlaceholder = shotGrid.querySelector('.image-placeholder');
            renderMainPreview(capturedImages[0], activeFilter);
            if (firstShotPlaceholder) {
                firstShotPlaceholder.classList.add('active-shot');
            }
            sessionStorage.setItem('selectedFinalImage', capturedImages[0]);
            sessionStorage.setItem('retakeShotIndex', '0'); // Default to index 0
        } else if (capturedImages.length > 0) {
             renderMainPreview(null);
        }

        // --- 5. BUTTON HANDLERS ---
        
        // Done Button
        const doneButton = document.getElementById('done-button');
        doneButton.addEventListener('click', (e) => {
            if (!sessionStorage.getItem('selectedFinalImage')) {
                e.preventDefault(); 
                alert('No image selected. Please ensure at least one shot was captured and click on it to proceed, or use RETAKE.');
            } else {
                console.log('[reviewshots] Before navigating to customizationphoto - sessionStorage state:');
                console.log('  - templateBackground:', sessionStorage.getItem('templateBackground'));
                console.log('  - templateStickers:', sessionStorage.getItem('templateStickers'));
                
                // Remove retake index before proceeding to customization
                sessionStorage.removeItem('retakeShotIndex');
                window.location.href='customizationphoto.html';
            }
        });

        // RETAKE Button
        retakeButton.addEventListener('click', (e) => {
            const indexToRetake = sessionStorage.getItem('retakeShotIndex');
            
            if (indexToRetake === null) {
                e.preventDefault();
                alert('Please click on the shot you want to retake first.');
                return;
            }
            
            // If an index is set, redirect to mainhome.html with the special retake flag
            window.location.href = `mainhome.html?retake=${indexToRetake}`;
        });
    });
</script>

</body>
</html>